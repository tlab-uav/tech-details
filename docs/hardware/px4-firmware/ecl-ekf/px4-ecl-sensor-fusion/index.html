<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/tech-details/blog/rss.xml" title="117411 TSL UAV Tech Details Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tech-details/blog/atom.xml" title="117411 TSL UAV Tech Details Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"><title data-react-helmet="true">px4-ecl-sensor-fusion | 117411 TSL UAV Tech Details</title><meta data-react-helmet="true" property="og:url" content="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="px4-ecl-sensor-fusion | 117411 TSL UAV Tech Details"><meta data-react-helmet="true" name="description" content="Coordinate Systems in Use for Fusion"><meta data-react-helmet="true" property="og:description" content="Coordinate Systems in Use for Fusion"><link data-react-helmet="true" rel="shortcut icon" href="/tech-details/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/" hreflang="x-default"><link rel="stylesheet" href="/tech-details/assets/css/styles.032a5ccc.css">
<link rel="preload" href="/tech-details/assets/js/runtime~main.fa9cdf7e.js" as="script">
<link rel="preload" href="/tech-details/assets/js/main.0141e7f4.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Hardware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Jetson TX2</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started/">Jetson Xavier NX</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/cameras/tiscamera-install/">Cameras</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">PX4 Firmware</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview/">UAV Platform</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/systems/vicon/">Systems</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/systems/ros-coordinate-systems/">ROS Coordinate Systems</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/unity-simulator/">Simulations</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/multiagentPX4/">MultiAgent PX4 SITL</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/vicon/">Vicon</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/pixhawk/getting-started/">Pixhawk Platform</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/pixhawk_v1/pixhawk/">Past Platforms : pixhawk v1</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/SAFMC/">SAFMC Drone Buildup</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/Crazyflie/">Crazyflie</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions/">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/linux/getting-started/overview/">Getting Started</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/packages/file-systems/">Software Packages</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/ros/using-catkin-build/">ROS</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/kernel/grub-default-kernel/">Drivers &amp; Kernel</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/productivity/git/git/">Productivity</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/productivity/git/git/">Git Version Control</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/cmake_debug/cmake/">CMake and Debugging</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/uiux/pangolin/">UI/UX Tools</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/git/gitConcepts/">Conceptualizing Git</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Research</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Flight Data</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/calibration/getting-started/">Sensor Calibration</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/collision-avoidance/overview-problems/">Collision Avoidance</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/vio/basalt-overview/">VIO</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/edt/edt-overview/">EDT</a></li></ul></div><a class="navbar__item navbar__link" href="/tech-details/docs/examples/doc0/">Examples (To Edit)</a><a class="navbar__item navbar__link" href="/tech-details/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" role="button" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Hardware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Jetson TX2</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started/">Jetson Xavier NX</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/cameras/tiscamera-install/">Cameras</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">PX4 Firmware</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview/">UAV Platform</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/systems/vicon/">Systems</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/ros-coordinate-systems/">ROS Coordinate Systems</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/unity-simulator/">Simulations</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/multiagentPX4/">MultiAgent PX4 SITL</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/vicon/">Vicon</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/pixhawk/getting-started/">Pixhawk Platform</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/pixhawk_v1/pixhawk/">Past Platforms : pixhawk v1</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/SAFMC/">SAFMC Drone Buildup</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/Crazyflie/">Crazyflie</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions/">Linux</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/getting-started/overview/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/packages/file-systems/">Software Packages</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/ros/using-catkin-build/">ROS</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/kernel/grub-default-kernel/">Drivers &amp; Kernel</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/productivity/git/git/">Productivity</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/git/git/">Git Version Control</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/cmake_debug/cmake/">CMake and Debugging</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/uiux/pangolin/">UI/UX Tools</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/git/gitConcepts/">Conceptualizing Git</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Research</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Flight Data</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/calibration/getting-started/">Sensor Calibration</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/collision-avoidance/overview-problems/">Collision Avoidance</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/vio/basalt-overview/">VIO</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/edt/edt-overview/">EDT</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/examples/doc0/">Examples (To Edit)</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/blog/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">PX4 Firmware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-toolchain-installation-setup/">Toolchain Installation &amp; Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-log-analysis/">Log Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-sitl/">PX4 SITL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-control-structure/">PX4 Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/mavlink-imu/">MAVLink IMU Topics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/time-synchronisation/">About Time Synchronisation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-camera-trigger/">Hardware Camera Trigger</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-dynamic-control-allocation/">PX4 Dynamic Control Allocation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-FAQ/">PX4 FAQ</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">ECL EKF</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-ekf/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-initialisation/">ECL EKF Initialisation</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/">ECL EKF Sensor Fusion (GPS)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/">ECL EKF Yaw Fusion</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-state-reset/">ECL EKF State Reset Logics</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="coordinate-systems-in-use-for-fusion"></a>Coordinate Systems in Use for Fusion<a class="hash-link" href="#coordinate-systems-in-use-for-fusion" title="Direct link to heading">#</a></h2><p>Conclusions:</p><ol><li>with velocity fusion, the mavros messages about velocity should be in body frame</li></ol><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="mavros-conversion"></a>Mavros Conversion<a class="hash-link" href="#mavros-conversion" title="Direct link to heading">#</a></h3><p><strong>(ROS Message --&gt; MAVLink)</strong></p><p>Mavros supports the conversion of ROS odometry message to MAVLINK odometry message. The coordinate frames are important here.</p><p>The MAVLink odometry message is hardcoded with frame of local NED frame, and body frame of NED as well.</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">odom.cpp</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">        mavlink</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">common</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">msg</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ODOMETRY msg </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frame_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> utils</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">enum_value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MAV_FRAME</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">LOCAL_FRD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">child_frame_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> utils</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">enum_value</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MAV_FRAME</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">BODY_FRD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>To get to this settings, the mavros actually does tf transform internally. </p><ul><li>Firstly it transform the <code>odom-&gt;pose.pose.position</code> to <code>odom_ned</code> frame, from whatever parent frame the odom message is carrying from ROS side.</li><li>For orientation <code>odom-&gt;pose.pose.orientation</code>, it uses the child <code>base_link_frd</code> frame to do the transform</li><li>if we set the ROS message properly, we can effectively by pass the two transformation (performing identity transformation)</li></ul><p>To take special note, the linear velocity and angular velocity are in local body frame (<code>MAV_FRAME::BODY_FRD</code>), not local map frame!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="px4-mavlink-receiver"></a>PX4 MAVLink Receiver<a class="hash-link" href="#px4-mavlink-receiver" title="Direct link to heading">#</a></h3><p><strong>(MAVLink --&gt; uORB)</strong></p><p>The receiver job is simple, it direcly copy the MAVLink odom message position over to the uorb <code>vehicle_odometry_s</code> message, assuming local FRD frame. (in function <code>handle_message_vision_position_estimate()</code> or <code>handle_message_odometry()</code>)</p><p>For <strong>linear velocity</strong> and <strong>angular rate</strong>, it must be in local <strong>body</strong> frame FRD (<code>vehicle_odometry_s::BODY_FRAME_FRD</code>).</p><p>It only supports:</p><ul><li><code>MAV_FRAME_BODY_FRD</code> for <code>odom.child_frame_id</code>, which controls the frame for velocity (direct copy without transformation)</li><li><code>MAV_FRAME_LOCAL_NED</code> or <code>MAV_FRAME_LOCAL_FRD</code> for <code>odom.frame_id</code>, which still does direct one-to-one copy for position and quaternion, but encode the uORB frame accordingly:<ul><li><code>odometry.local_frame = vehicle_odometry_s::LOCAL_FRAME_NED</code>, or</li><li><code>odometry.local_frame = vehicle_odometry_s::LOCAL_FRAME_FRD</code>  (<strong>MAVROS default</strong>)</li></ul></li></ul><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>The difference between local frame NED and local frame FRD</h5></div><div class="admonition-content"><p>LOCAL_FRAME_NED has attempt to align with true north and east direction, where as LOCAL_FRAME_FRD has arbitary horizontal alignment.</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="px4-ekf2-external-vision-data-processing"></a>PX4 EKF2 External Vision Data Processing<a class="hash-link" href="#px4-ekf2-external-vision-data-processing" title="Direct link to heading">#</a></h3><p><strong>(uORB --&gt; EKF Samples)</strong></p><p>The received <code>vehicle_odometry_s</code> uORB message is processed in the main <code>Ekf2::Run()</code> loop, which is converted to <code>extVisionSample</code> datatype:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">extVisionSample</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Vector3f pos</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">///&lt; XYZ position in external vision&#x27;s local reference frame (m) - Z must be aligned with down axis</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Vector3f vel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">///&lt; FRD velocity in reference frame defined in vel_frame variable (m/sec) - Z must be aligned with down axis</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Quatf quat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">///&lt; quaternion defining rotation from body to earth frame</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Vector3f posVar</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">///&lt; XYZ position variances (m**2)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    Matrix3f velCov</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">///&lt; XYZ velocity covariances ((m/sec)**2)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> angVar</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">///&lt; angular heading variance (rad**2)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    velocity_frame_t vel_frame </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> BODY_FRAME_FRD</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">uint64_t</span><span class="token plain"> time_us</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">///&lt; timestamp of the measurement (uSec)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The velocity frame follows what is in the uORB message, which gives <code>estimator::BODY_FRAME_FRD</code> frame. All entries (position, velocity and quaternion) are copied one-to-one in coordinates from uORB message to <code>extVisionSample</code>. The message are stored using <code>setExtVisionData()</code> function, which in turns stores data to <code>_ext_vision_buffer</code>.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>This is to say, the position and attitude is in local FRD frame, and velocity is in body FRD frame (not local!).</p></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="position--velocity-fusion-logics"></a>Position / Velocity Fusion Logics<a class="hash-link" href="#position--velocity-fusion-logics" title="Direct link to heading">#</a></h3><p><code>controlExternalVisionFusion()</code> Logic in <code>control.cpp</code></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="regarding-ev-rotation"></a>Regarding EV Rotation<a class="hash-link" href="#regarding-ev-rotation" title="Direct link to heading">#</a></h4><p>For <strong>every</strong> measurement, if <code>rotate EV</code> option is enabled and EV is used, it rotates the EV measurement, aligning the two quaternions! Which generates a rotation matrix <code>_R_ev_to_ekf</code>, which express the EV frame in EKF frame, essentially converting coordinates from EV to EKF (local NED).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="regarding-position-fusion"></a>Regarding Position Fusion<a class="hash-link" href="#regarding-position-fusion" title="Direct link to heading">#</a></h4><p>If GPS is used, then all position measurement EV gives, would be used as relative measurement. The logic automatically calculates position changes,</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">Vector3f ev_delta_pos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _ev_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pos </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _pos_meas_prev</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">ev_delta_pos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _R_ev_to_ekf </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> ev_delta_pos</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>and rotates this relative position into EKF frame. Think about it, if there is no _R_ev_to_ekf applied, the two coordinate frame will have rotation drift, as the position measurement is originally in <code>vehicle_odometry_s::LOCAL_FRAME_FRD</code>, not body frame (it cant be body frame anyway). To make things worse, EV local frame WILL drift, due to is incremental nature, and the drift is NOT observable.</p><p>Therefore, rotating the delta position with the current attitude difference between EV and EKF make sense. The delta pose in measured in DRIFTED EV local frame, so to eliminate the drift, we should rotate it to the body frame, hence <code>_ev_sample_delayed.quat.inversed()</code>. Thereafter, EKF is expecting the position measurement to be in the local frame, not body frame, hence we need to convert the measurement into a <strong>fake</strong> local measurement, by multiplying the current state rotation, hence <code>_state.quat_nominal</code>.</p><p>The innovation is calculated as the following:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// use the change in position since the last measurement</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">_ev_pos_innov</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_hpos_pred_prev</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ev_delta_pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">_ev_pos_innov</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_hpos_pred_prev</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ev_delta_pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>Conclusion, it is safe to feed the EKF with odometry measured in EV local frame, with EV rotation turned on. However, the vision position will only be used as a relative measurement.</p></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="regarding-velocity-fusion"></a>Regarding Velocity Fusion<a class="hash-link" href="#regarding-velocity-fusion" title="Direct link to heading">#</a></h4><p>Lets now analyse the case for velocity fusion. It is programmed in function <code>getVisionVelocityInEkfFrame()</code>.</p><p>There are two cases:</p><ul><li>(<strong>MAVROS default</strong>) If the velocity is measured in <code>BODY_FRAME_FRD</code>, then EV-EKF rotation is not applied, instead it applies<div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">vel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _R_to_earth </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_ev_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vel </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> vel_offset_body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div>which is essentially from body frame to EKF local frame.</li><li>If the velocity is measured in <code>LOCAL_FRAME_FRD</code>, then EV-EKF rotation is applied<div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">vel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _R_ev_to_ekf </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">_ev_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vel </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> vel_offset_earth</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ul><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>For velocity fusion, the rotate EV will not make a difference, as Mavros-PX4 interfaces request the velocity to be in body frame in any case.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gps-usage-in-ekf"></a>GPS Usage in EKF<a class="hash-link" href="#gps-usage-in-ekf" title="Direct link to heading">#</a></h2><p>PX4 Firmware version, 1.11.1 (Sep 2020)</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="10-oct-2020-local-position-estimate--green-light"></a>10 Oct 2020 (Local Position Estimate &amp; Green Light):<a class="hash-link" href="#10-oct-2020-local-position-estimate--green-light" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="issue-1-gps-lock-does-not-turn-green-postive-beeping-sequence"></a>Issue 1: GPS Lock Does not Turn Green (Postive Beeping Sequence)<a class="hash-link" href="#issue-1-gps-lock-does-not-turn-green-postive-beeping-sequence" title="Direct link to heading">#</a></h4><p>Green light inditates home position set</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">Relevant logics</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* @brief This function initializes the home position an altitude of the vehicle. This happens first time we get a good GPS fix and each</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*        time the vehicle is armed with a good GPS fix.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">**/</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token class-name">Commander</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">set_home_position</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Need global and local position fix to be able to set home</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_global_position_valid </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_local_position_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> vehicle_global_position_s </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">gpos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _global_position_sub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Ensure that the GPS accuracy is good enough for intializing home</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eph </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> _param_com_home_h_t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">epv </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> _param_com_home_v_t</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> vehicle_local_position_s </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lpos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _local_position_sub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Set home position</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home_position_s home</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">timestamp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hrt_absolute_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_hpos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">alt</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">valid_alt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">y</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">z</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">yaw </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">heading</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _heading_reset_counter </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">heading_reset_counter</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            home</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">manual_home </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// play tune first time we initialize HOME</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_home_position_valid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">tune_home_set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// mark home position as set</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_home_position_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _home_pub</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">home</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_home_position_valid</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><strong>Root Causes:</strong></p><ul><li>Buggy / incompatible GPS module, which take around a minute to successfully load the device driver after boot. It can be proved by GPS data is only logged after a minute or so, upon boot.</li><li>Magnetometer ID 0 and 1 might have been mixed up. Currently 1 is external, and 0 is internal which is now disabled. It appears that bad compass health will also prevent green light</li><li>EKF bug in older 1.10.1 (EV Rotation initialisation)</li><li>It appears to be that sometime the system will determin XY position drift too much, if we move the drone alot. The vertical position check seems to be fine.</li><li>Another note, the EKF internal GPS valid check is DIFFERENT from the green light checks!</li><li>The green light checks takes around 10 seconds</li></ul><p><strong>After Fixes:</strong></p><ul><li>Green light shows up around <code>10-15 seconds</code></li><li>Local position estimate is always valid</li><li>Next to test: without the shielding box, will GPS still turn green consistently?</li><li>EKF Tuning (Yaw fusion problems?)</li></ul><p><img src="/tech-details/assets/images/ekf-drift-against-gps-0b891051cb8d2e2f8b51cddfd6e2b626.png"></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="if-gps-still-not-turning-green"></a>If GPS Still Not Turning Green<a class="hash-link" href="#if-gps-still-not-turning-green" title="Direct link to heading">#</a></h4><p>Check logs for the following values:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">uint16 gps_check_fail_flags     # Bitmask to indicate status of GPS checks </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> see definition below</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property directive keyword" style="color:#00009f">bits</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property expression" style="color:#36acaa">are </span><span class="token macro property expression boolean" style="color:#36acaa">true</span><span class="token macro property expression" style="color:#36acaa"> when corresponding test has failed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_GPS_FIX </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">        # </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> insufficient fix </span><span class="token function" style="color:#d73a49">type</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">no </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">D solution</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MIN_SAT_COUNT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">      # </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> minimum required sat count fail</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MIN_PDOP </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">       # </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> minimum required PDOP fail</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MAX_HORZ_ERR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain">       # </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> maximum allowed horizontal position error fail</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MAX_VERT_ERR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">       # </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> maximum allowed vertical position error fail</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MAX_SPD_ERR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">        # </span><span class="token number" style="color:#36acaa">5</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> maximum allowed speed error fail</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MAX_HORZ_DRIFT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token plain">     # </span><span class="token number" style="color:#36acaa">6</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> maximum allowed horizontal position drift fail </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">requires</span><span class="token plain"> stationary vehicle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MAX_VERT_DRIFT </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token plain">     # </span><span class="token number" style="color:#36acaa">7</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> maximum allowed vertical position drift fail </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">requires</span><span class="token plain"> stationary vehicle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MAX_HORZ_SPD_ERR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">   # </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> maximum allowed horizontal speed fail </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">requires</span><span class="token plain"> stationary vehicle</span></span><span class="token-line" style="color:#393A34"><span class="token plain">uint8 GPS_CHECK_FAIL_MAX_VERT_SPD_ERR </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">9</span><span class="token plain">   # </span><span class="token number" style="color:#36acaa">9</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> maximum allowed vertical velocity discrepancy fail</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>One possibility is that <strong>ERROR CODE = 232</strong> which means </p><ul><li>GPS_CHECK_FAIL_MAX_HORZ_ERR, </li><li>GPS_CHECK_FAIL_MAX_SPD_ERR, </li><li>GPS_CHECK_FAIL_MAX_HORZ_DRIFT, </li><li>GPS_CHECK_FAIL_MAX_VERT_DRIFT</li></ul><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>To inspect GPS check failures on the fly, set the parameter COM_ARM_WO_GPS to false. This will enforce checking GPS when arming</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ParamBool</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">px4</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">params</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">COM_ARM_WO_GPS</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> _param_arm_without_gps</span><span class="token punctuation" style="color:#393A34">,</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// get GPS check status</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token class-name">Ekf</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">get_gps_check_status</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">uint16_t</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">val</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">val </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _gps_check_fail_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="26-oct-2020-successful-fusion"></a>26 Oct 2020 (Successful Fusion)<a class="hash-link" href="#26-oct-2020-successful-fusion" title="Direct link to heading">#</a></h4><p>Issues:</p><ul><li>Still encounter difficulties in getting GPS green light<ul><li>Investigation shows gps_check_fail_flags code = 232, which includes position drift threshold (<code>EKF2_REQ_HDRIFT</code>) of 0.1m/s</li><li>Calibration of / changing the active magnetometer does not help</li></ul></li></ul><p>However, this time, after successful locking of GPS, the performance seems reasonable:</p><ul><li>Fusion Mode in use: EKF2_AID_MASK = 449 (use GPS,  rotate external vision,  <strong>GPS yaw fusion</strong>, vision velocity fusion)</li><li>Previously Yaw fusion of GPS is not enabled, so purely magnetometer</li></ul><p><img src="/tech-details/assets/images/ekf-fusion-against-gps-e5ddcb70aaadd5b09fc3c7a8747d381c.png">
<a target="_blank" href="/tech-details/assets/files/08_25_12-9025052a66ab4d1d297f8476c470b5f4.ulg/">Flight Log (includes parameter lists)</a></p><p>This is tested with the latest VIO code, which fixes optimisation bugs and KF creation logics (more stable and robust)</p><hr><p>There is a check parameter <code>CBRK_VELPOSERR</code>, which runs the following code:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/* Check estimator status for signs of bad yaw induced post takeoff navigation failure</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* for a short time interval after takeoff. Fixed wing vehicles can recover using GPS heading,</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* but rotary wing vehicles cannot so the position and velocity validity needs to be latched</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* to false after failure to prevent flyaway crashes */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_quality_checks </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vehicle_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> vehicle_status_s</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">VEHICLE_TYPE_ROTARY_WING</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arming_state </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> vehicle_status_s</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">ARMING_STATE_STANDBY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// reset flags and timer</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _time_at_takeoff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hrt_absolute_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _nav_test_failed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _nav_test_passed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_land_detector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">landed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// record time of takeoff</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _time_at_takeoff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hrt_absolute_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// if nav status is unconfirmed, confirm yaw angle as passed after 30 seconds or achieving 5 m/s of speed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> sufficient_time </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">hrt_elapsed_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_time_at_takeoff</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30</span><span class="token plain">_s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> sufficient_speed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vx </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vx </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vy </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vy </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">25.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> innovation_pass </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> estimator_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vel_test_ratio </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> estimator_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pos_test_ratio </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_nav_test_failed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_nav_test_passed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// pass if sufficient time or speed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sufficient_time </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> sufficient_speed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        _nav_test_passed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// record the last time the innovation check passed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">innovation_pass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        _time_last_innov_pass </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hrt_absolute_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// if the innovation test has failed continuously, declare the nav as failed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">hrt_elapsed_time</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_time_last_innov_pass</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">_s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        _nav_test_failed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token function" style="color:#d73a49">mavlink_log_emergency</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">mavlink_log_pub</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Critical navigation failure! Check sensor calibration&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* run global position accuracy checks */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Check if quality checking of position accuracy and consistency is to be performed</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run_quality_checks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_nav_test_failed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_global_position_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_local_position_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_local_velocity_valid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_skip_pos_accuracy_check</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// use global position message to determine validity</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">check_posvel_validity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eph</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _eph_threshold_adj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> gpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_last_gpos_fail_time_us</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                            </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_gpos_probation_time_us</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_global_position_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_status_changed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// use local position message to determine validity</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">check_posvel_validity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xy_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eph</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _eph_threshold_adj</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_last_lpos_fail_time_us</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_lpos_probation_time_us</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_local_position_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_status_changed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">check_posvel_validity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v_xy_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">evh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _param_com_vel_fs_evh</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lpos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">timestamp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_last_lvel_fail_time_us</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_lvel_probation_time_us</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">status_flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">condition_local_velocity_valid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_status_changed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The following code shows magnatometer must be used for GPS and/or EV navigation</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token class-name">Ekf</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">shouldInhibitMag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If the user has selected auto protection against indoor magnetic field errors, only use the magnetometer</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// if a yaw angle relative to true North is required for navigation. If no GPS or other earth frame aiding</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// is available, assume that we are operating indoors and the magnetometer should not be used.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Also inhibit mag fusion when a strong magnetic field interference is detected or the user</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// has explicitly stopped magnetometer use.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> user_selected </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mag_fusion_type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> MAG_FUSE_TYPE_INDOOR</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> heading_not_required_for_navigation </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ev_pos</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                             </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ev_vel</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user_selected </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> heading_not_required_for_navigation</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">           </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">isStrongMagneticDisturbance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This give three flags <code>condition_global_position_valid</code>, <code>condition_local_position_valid</code>, <code>condition_local_velocity_valid</code></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ekf-debugging"></a>EKF Debugging<a class="hash-link" href="#ekf-debugging" title="Direct link to heading">#</a></h2><p>SDLOG_PROFILE parameter to set</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">logged_topics.cpp</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token class-name">LoggedTopics</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">add_estimator_replay_topics</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// for estimator replay (need to be at full rate)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ekf2_timestamps&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;ekf_gps_position&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// current EKF2 subscriptions</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;airspeed&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;optical_flow&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;sensor_combined&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;sensor_selection&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;vehicle_air_data&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;vehicle_land_detected&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;vehicle_magnetometer&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;vehicle_status&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;vehicle_visual_odometry&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;vehicle_visual_odometry_aligned&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic_multi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;distance_sensor&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">add_topic_multi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;vehicle_gps_position&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">EKF2_MAG_TYPE</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Integer definitions for mag_fusion_type</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MAG_FUSE_TYPE_AUTO</span><span class="token macro property" style="color:#36acaa">      </span><span class="token macro property expression number" style="color:#36acaa">0</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property comment" style="color:#999988;font-style:italic">///&lt; The selection of either heading or 3D magnetometer fusion will be automatic</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MAG_FUSE_TYPE_HEADING</span><span class="token macro property" style="color:#36acaa">   </span><span class="token macro property expression number" style="color:#36acaa">1</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property comment" style="color:#999988;font-style:italic">///&lt; Simple yaw angle fusion will always be used. This is less accurate, but less affected by earth field distortions. It should not be used for pitch angles outside the range from -60 to +60 deg</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MAG_FUSE_TYPE_3D</span><span class="token macro property" style="color:#36acaa">        </span><span class="token macro property expression number" style="color:#36acaa">2</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property comment" style="color:#999988;font-style:italic">///&lt; Magnetometer 3-axis fusion will always be used. This is more accurate, but more affected by localised earth field distortions</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MAG_FUSE_TYPE_UNUSED</span><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression number" style="color:#36acaa">3</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property comment" style="color:#999988;font-style:italic">///&lt; Not implemented</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MAG_FUSE_TYPE_INDOOR</span><span class="token macro property" style="color:#36acaa">    </span><span class="token macro property expression number" style="color:#36acaa">4</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property comment" style="color:#999988;font-style:italic">///&lt; The same as option 0, but magnetometer or yaw fusion will not be used unless earth frame external aiding (GPS or External Vision) is being used. This prevents inconsistent magnetic fields associated with indoor operation degrading state estimates.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">define</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property macro-name" style="color:#36acaa">MAG_FUSE_TYPE_NONE</span><span class="token macro property" style="color:#36acaa">  </span><span class="token macro property expression number" style="color:#36acaa">5</span><span class="token macro property expression" style="color:#36acaa">   </span><span class="token macro property comment" style="color:#999988;font-style:italic">///&lt; Do not use magnetometer under any circumstance. Other sources of yaw may be used if selected via the EKF2_AID_MASK parameter.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/**</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Type of magnetometer fusion</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Integer controlling the type of magnetometer fusion used - magnetic heading or 3-component vector. The fuson of magnetomer data as a three component vector enables vehicle body fixed hard iron errors to be learned, but requires a stable earth field.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;Automatic&#x27; magnetic heading fusion is used when on-ground and 3-axis magnetic field fusion in-flight with fallback to magnetic heading fusion if there is insufficient motion to make yaw or magnetic field states observable.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;Magnetic heading&#x27; magnetic heading fusion is used at all times</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;3-axis&#x27; 3-axis field fusion is used at all times.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;VTOL custom&#x27; the behaviour is the same as &#x27;Automatic&#x27;, but if fusing airspeed, magnetometer fusion is only allowed to modify the magnetic field states. This can be used by VTOL platforms with large magnetic field disturbances to prevent incorrect bias states being learned during forward flight operation which can adversely affect estimation accuracy after transition to hovering flight.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;MC custom&#x27; the behaviour is the same as &#x27;Automatic, but if there are no earth frame position or velocity observations being used, the magnetometer will not be used. This enables vehicles to operate with no GPS in environments where the magnetic field cannot be used to provide a heading reference. Prior to flight, the yaw angle is assumed to be constant if movement tests controlled by the EKF2_MOVE_TEST parameter indicate that the vehicle is static. This allows the vehicle to be placed on the ground to learn the yaw gyro bias prior to flight.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;None&#x27; the magnetometer will not be used under any circumstance. If no external source of yaw is available, it is possible to use post-takeoff horizontal movement combined with GPS velocity measurements to align the yaw angle with the timer required (depending on the amount of movement and GPS data quality). Other external sources of yaw may be used if selected via the EKF2_AID_MASK parameter.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @group EKF2</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 0 Automatic</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 1 Magnetic heading</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 2 3-axis</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 3 VTOL custom</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 4 MC custom</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 5 None</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @reboot_required true</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ekf-status"></a>EKF Status<a class="hash-link" href="#ekf-status" title="Direct link to heading">#</a></h3><p>ekf status, global position valid:</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">ekf_helper.cpp</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> </span><span class="token class-name">Ekf</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">global_position_is_valid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// return true if the origin is set we are not doing unconstrained free inertial navigation</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// and have not started using synthetic position observations to constrain drift</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_NED_origin_initialised </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_deadreckon_time_exceeded </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">_using_synthetic_position</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ekf2run-in-modulesekf2ekf2_maincpp"></a><code>Ekf2::Run()</code> in <code>modules/ekf2/ekf2_main.cpp</code><a class="hash-link" href="#ekf2run-in-modulesekf2ekf2_maincpp" title="Direct link to heading">#</a></h3><p>In the <code>Ekf2::Run()</code> function, the GPS updates are attempted when new <code>sensor_combined</code> data is available. If GPS have updates and enabled in EKF fusion, then <code>blend_gps_data()</code> is performed, where it should fail because we only have 1 GPS? Then the hardcoded logic is used to set the <code>_gps_select_index</code>. Eventually, the selected GPS data, is set to EKF by <code>setGpsData()</code>, and also output as logged <code>ekf_gps_position</code> uORB topic.</p><p>Within <code>setGpsData()</code>, there is a logic <code>collect_gps(const gps_message &amp;gps)</code>, it has a treatment of GPS relative position initialisation. It supports GPS initialisation, after the filter has been running. WHat it does is to take the current state estimate from the filter, perform <code>map_projection_reproject</code> with the negative of the state estimate, so we can obtain the starting position&#x27;s latitude and longitude, and use that to <code>map_projection_init_timestamped</code>. It will return with <code>_NED_origin_initialised &amp;&amp; (gps.fix_type &gt;= 3)</code>. At last, a sample is prepared, and <code>_gps_buffer</code> is updated, stored as NE earth frame position in meters. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ekfupdate-in-libeclekfcontrolcpp"></a><code>Ekf::update()</code> in <code>lib/ecl/EKF/control.cpp</code><a class="hash-link" href="#ekfupdate-in-libeclekfcontrolcpp" title="Direct link to heading">#</a></h3><p>Ekf is a member variable within the EKF2 class, and its member function <code>update()</code> is called within <code>Ekf2::Run()</code> function, after all the sensor data gathering logic. </p><p>Within the update function, it calls <code>controlFusionModes()</code> when there is imu update. It in turn calls <code>controlGpsFusion()</code>. <code>tilt_align</code> flags signify the convergence of roll and pitch with in +- 3 degree.</p><p>If the fusion of GPS yaw is enabled, then after convergence of tilt, the <code>gps_yaw</code> flag will be turned on, and all other yaw fusion (EV) would be disabled. It will not be turned off ever again. With the flag on, it will run <code>fuseGpsAntYaw()</code>. It is a bit strange that the yaw fusion is never turned of regardless of the subsequent GPS quality. If the GPS fusion starts it should emit:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ECL_INFO_TIMESTAMPED</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;EKF commencing GPS fusion&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    _time_last_gps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _time_last_imu</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="case-when-gps-fails-but-ev-valid"></a>Case when GPS fails (but EV valid)<a class="hash-link" href="#case-when-gps-fails-but-ev-valid" title="Direct link to heading">#</a></h4><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Handle the case where we are using GPS and another source of aiding and GPS is failing checks</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps  </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> gps_checks_failing </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opt_flow </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> _control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ev_pos </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> _control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ev_vel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// Reset position state to external vision if we are going to use absolute values</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ev_pos </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fusion_mode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> MASK_ROTATE_EV</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token function" style="color:#d73a49">resetPosition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">ECL_WARN_TIMESTAMPED</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;EKF GPS data quality poor - stopping use&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="after-innovation-calculation"></a>After Innovation Calculation<a class="hash-link" href="#after-innovation-calculation" title="Direct link to heading">#</a></h4><p>controlVelPosFusion();</p><p>controlExternalVisionFusion();</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="about-gps-and-external-vision-fusion"></a>About GPS and External Vision Fusion<a class="hash-link" href="#about-gps-and-external-vision-fusion" title="Direct link to heading">#</a></h2><p>GPS sample is in meters relative to home.</p><div class="codeBlockContainer_K1bP"><div style="color:#393A34;background-color:#f6f8fa" class="codeBlockTitle_eoMF">estimator_interface.cpp</div><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar codeBlockWithTitle_2JqI" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// Only calculate the relative position if the WGS-84 location of the origin is set</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">collect_gps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> lpos_x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> lpos_y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">map_projection_project</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">_pos_ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lat </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0e7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gps</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lon </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0e7</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lpos_x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lpos_y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            gps_sample_new</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lpos_x</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            gps_sample_new</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lpos_y</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            gps_sample_new</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            gps_sample_new</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0f</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* Transforms a point in the geographic coordinate system to the local</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * azimuthal equidistant plane using the projection given by the argument</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* @param x north</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* @param y east</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* @param lat in degrees (47.1234567Â°, not 471234567Â°)</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* @param lon in degrees (8.1234567Â°, not 81234567Â°)</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">* @return 0 if map_projection_init was called before, -1 else</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="external-vision-location-fusion-when-gps-fusion-is-enabled"></a>External Vision location fusion, when GPS fusion is enabled<a class="hash-link" href="#external-vision-location-fusion-when-gps-fusion-is-enabled" title="Direct link to heading">#</a></h4><p>for <code>_fuse_hpos_as_odom</code> is enabled if GPS is used</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Use an incremental position fusion method for EV position data if GPS is also used</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fusion_mode </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> MASK_USE_GPS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _fuse_hpos_as_odom </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _fuse_hpos_as_odom </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>ecl seems to use EV as relative pose measurement, using variable <code>_hpos_pred_prev</code></p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic">// use the change in position since the last measurement</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    _vel_pos_innov</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_hpos_pred_prev</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ev_delta_pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                    _vel_pos_innov</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_hpos_pred_prev</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ev_delta_pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>vision yaw is disabled, if gps is enabled</p><p>may try disable magnetometer 3d fusion. use <code>fuseHeading()</code></p><p>GPS position and velocity fusion is lumped together</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Only use GPS data for position and velocity aiding if enabled</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _fuse_pos </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _fuse_vert_vel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _fuse_hor_vel </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// correct velocity for offset relative to IMU</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Vector3f ang_rate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _imu_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delta_ang </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1.0f</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> _imu_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">delta_ang_dt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Vector3f pos_offset_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps_pos_body </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">imu_pos_body</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Vector3f vel_offset_body </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">cross_product</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ang_rate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pos_offset_body</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Vector3f vel_offset_earth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _R_to_earth </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> vel_offset_body</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vel </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> vel_offset_earth</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// correct position and height for offset relative to IMU</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            Vector3f pos_offset_earth </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _R_to_earth </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> pos_offset_body</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pos_offset_earth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pos_offset_earth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hgt </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">pos_offset_earth</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// calculate observation process noise</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> lower_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fmaxf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps_pos_noise</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">opt_flow </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> _control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ev_pos </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> _control_status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flags</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ev_vel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// if we are using other sources of aiding, then relax the upper observation</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// noise limit which prevents bad GPS perturbing the position estimate</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                _posObsNoiseNE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fmaxf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hacc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lower_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// if we are not using another source of aiding, then we are reliant on the GPS</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">// observations to constrain attitude errors and must limit the observation noise value.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">float</span><span class="token plain"> upper_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fmaxf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pos_noaid_noise</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lower_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">                _posObsNoiseNE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> math</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">constrain</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hacc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lower_limit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> upper_limit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token function" style="color:#d73a49">_velObsVarNED</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_velObsVarNED</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_velObsVarNED</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">sq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">fmaxf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sacc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps_vel_noise</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// calculate innovations</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _vel_pos_innov</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">vel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">vel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _vel_pos_innov</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">vel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">vel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _vel_pos_innov</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">vel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">vel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _vel_pos_innov</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _vel_pos_innov</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> _gps_sample_delayed</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pos</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic">// set innovation gate size</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _posInnovGateNE </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fmaxf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps_pos_innov_gate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            _hvelInnovGate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> _vvelInnovGate </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fmaxf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_params</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gps_vel_innov_gate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0f</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="29-oct-2020-experiment-of-gps-green-light-issue"></a>29 Oct 2020 (Experiment of GPS Green light issue)<a class="hash-link" href="#29-oct-2020-experiment-of-gps-green-light-issue" title="Direct link to heading">#</a></h3><p>Firstly, to make sure the GPS module used on the drone can work properly. An indoor test has been conducted.</p><p>Test Results:</p><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQMAAACOCAYAAAA1iG15AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAA+4SURBVHhe7Z1Bi9xGFsf1LfwNzBx8sZcs2WbDhg0GNwbjJUvsOGzYsEnDgMGwRx+Mb3My9DXMIYe55bz0IZchl3wCXzJ9yTfR1nslqatKr0olTaun6/X/Dz88rSpJJb2qv0olqVw9evSn+v79+0AZiCsYS/XJJ38WE0DZIK5gLNWnn/5FTABlg7iCsVSLxV/FBFA2iCsYS/XZZ38TE0DZIK5gLNXnn/9dTABlg7iCsVRffPFYTFDH8qK+vrmpb67O5XRlnExcczi/qm8o9g7X11f1xVLIe8JUjx8/ERO0sby4NkZwVV/dXNXnQro2TiWuWZAZXF/US2fZsjGIq3Mn34lTPXnyVEzQxbK+uLaBP786jQpwGnHNRDADgurCqfQUc6iePn0mJqiCbxGaHgFVjBOoACcR11wiZmB7izCDlurZs3+ICZqgK8D1xbL5fW5uFa7V3y+eQlyzSfQMdvUCVM+f/1NM0EO/8Z9CJdAf1xH0zGBZn5teAQ0insL4US7Vl1++EBPUIF0VIlcKTaiP6xgo3sHThBt+moBegUv11VevxAQtyL0A/bcK2uM6CsH8l0tTB65N3cCYQUf19df/EhNU0L5bEENxRVAd17FEe4KnMX6US/XNN/8WEzTAo8Wx2wHuOuq9Z9Qc19FEzWD3yNlffppU3377HzGhfGyg4wOFuiuC3rhOINkzgBm0VN99txITisd9tyCC5ufMauM6BckMmjGDaM/xBKm+/15nY8hq6BmGUSpa4zoJviUMxoturuuri3MYgUO1Wr0WE0DZIK5gLNX5+RsxAZQN4grGUr1+/V8xAZQN4grGUv344481AACwGdS/rwAAJw7MAADAwAwAAAzMAADAwAwAAAzMAADAwAxmZvOiqqsXSzFtCtu39/a6vWm8rNcPzXFVKe7V61+kdcGxAjOYGZ1mELKsV8YAVpdSGigFmMHMwAxuC237rN6IaWCfwAxmBmZwS35Z1AuYwUGAGcxMaAb0e/H2JVfyVXfffa9e0TJnPWJ7eWYagpPn8qVoBttLd1uGhzavmyc3H22fyrd92+z74aLeOukyaTMIj2Pxdults9tXk96eCz7WbrlNwzjEfMAMZiY0A25sL87qlVnWNghqpNQYvMZkGlBFV8Su8r8026L1AjPgfKaROI263R6bzsh83ACNSSyc8g2TMIPwOH5Z2sHH9hiaK3/XyE36ym307fr0N5gVmMHMSGYgVW4/nx2t7zeuZhR/MJ/Ba0S5+eLlSxMzg8h+3a4/7T/V+4AZHAyYwcyIZuD8Fpcn7pP7+WJdZ+cKm5vP/I6VL03EDKLH4ZqEXZdvHaTywQwOBsxgZuY3g1hDCc0gI5/5vX8zMMcfoctPtw7m9sfmDcZPYAYHA2YwM+gZjGzIPGbgjGPADA4GzGBmJplB9B7fLh/OZ/DuxXPz7dkMUvtN4J0zmMHBgBnMzDQzaH5TI+iu5uOfJniNMDPffs1AOg7a71m9MAZEDZzSvUeNTc+g21ayVwP2CcxgZqaagV3Wf8+AG3W4vmkw/vsDZ16jH5Nv32ZA+O8ZmFsAs1/X5Gi8oCsTHac7ZmDYOOmxfYDbAzMAADAwAwAAAzMAADAwAwAAY80AUqePHz82f0FQnmAGSgUzgMYKZqBUMANorGAGSgUzgMYKZqBUMANorGAGSgUzgMYqzww2K+d1UZdVvWmycJ7Fut42Pztt1/b99zZjdFuLeu2svF2vnFdYF/XKTYxqW2/W9n37dr3FetMv0561NfusugM8Dt2VGWw363q1MOfDjcFqXW/mDsI+FavLjabG+xjriat8M0icHJaYZ2M/R3UbMpuBYyKC+KQtTJ52ta2wHUGblal8pgzueuuFWXbEAZhLd2EGHDcyda/lG4Ne0fJ0zI9KOfV9gk7YDLZyQxw0A7te75wNlsEaRm896pmQsTQ/80TbktaJLT8+HdwMuAfo9+5ckSEMmfnR6M7N4G7q2Wxm0F6le+sMmkFEXNlS69EJjFfGUYrta7AMx6NDmwHH+4iveqN012ZwR/VsFjOw3fxI/qlmMFgG26PIufpszbZi4wq2q9um2XTaZGx5t44TZGoYXA4T1BX1jpr80rhHb2yEutjBsU4ZPzmsGUR6cwnROaNz1B2be7yJ+LQayjMmBj0N1LUw3qS8ODbrJcqUqmdza/9mQP+mDoDTx5pBZmVjRzUn0NwW+Petjtr9t8nSuEKsjJHlYeXgir5a1SuzbLcbWzZ3Nzbw5lztClNvTKXiAbg2Y3OV6M4nj58MV5DDmsH4XhkfuznOhXOOWGPik8iTGwNRtP0RZpAVR6P2mAfLFKt/MyvfDNilfLyrcJfHBMEEJnqFjmwrdfKjtxyibCCoDLRdv7JFTKVpcN3iWDAiy+XK0c/nd6VjBmeXd/lon9nHvlMRZtA7RznxyYthXgwiGjjnfrwz42iUXaZY/ZtZ++0ZtBWCAxOpHCMPlE/ghMbAaq8Y7fpho+8UBDRWxshyv3L0f7fylifOkb8+NTQyV2NqI07CMZgBH0fE8MVzlBOfzBhmxSCmgfrubSM7jiPKNLKN7EuzDSDyAY5oUJL4kdTQfgdlGxOfaw6cUzkDunjEyhhZPino0UotrE+mRqPxXM5Cxwyk+hGukBOfzBhmxSCmoKyhpsYxu0wj2sg+NZsZmEO0V+Xw4DMPlE/Q6EeCknKuKoFiZYwsnxT0MWbgiscMErdhjQ5rBgNlJgX1Q8yfE5/MGGbFIKZeXfblbQNmIEjKwycquGLkHCivF7nNiInWEcvodmEzrmCkWBkjy6cFPVaWiIk6yrnvPbQZ2Jglzm1QP+RzlBOfvBjmxSAiqS47mhrH7DLltJEZNK8ZGPGBugc2eKD2JA5d+fpq1jMndbcmvf1mAhJWQtq/s3l+TGXydGWKmVFkeRjM3KDbsrjbo/LSCPguH+XxHps1PQNh854ObgZG7ZMkeqy2O0Xmbzq/QW8meY4G4pOdJyMGoug4hLrcKtyGLU86jqTsMk25GO5B+WZgginRBTh6AgOH5G2lzMBWdmlf/gmXZPZFAXDW6T26MmorZ5fHffW5kX2F1qa7cZKWi5XDXamRtNx7Pr0wx0cNycsXHtMxjhk4IrOiR2pOeaVvE2LniJQTn6E8Y2LQE9fR3bZ32Ho7LY7jyhSrf3Mqzwygg4p6M+N7Rr7uzAygTvuI4yEFM7hDsfsb23erC13xhntAw4IZHE5zxvGQghncqejesn1kaJG6xFMEMzik5ovjIcVmQBUH6OK3P/4HwCjQM1AqKdgApIAZKJUUbABSwAyUSgo2AClgBkolBRuAFDADpZKCDUAKmIFSScEGIIUuM8h50SOSx3+d1JlZqFBJwdbGh1cmVq/ei2m//XFZv3lU1Q/eXdrfPz3p3gHweVJ/cNb58O6sftClmb/fva9/7tJ1o8gM6J14CmDKDOQ8/G44feTSLLNTUZX19lgoKdj6eF8/Nw32za9CGjX+Rz/sGnL4W4DNxeT50G7v1/dsKHHD0YUaM+A3wNZr53PlvuQ89GFUf53YRyWlSAq2Rn42V/J+IyeTqOrnPznLBs1AWIf49Yf6wSO396AXHWbQzWUgN2xWLA9/Lmq/RvPU5S9TUrB1Ym8H3EYsGkSWGUR6GSeCAjOgT6Tbxh0zg0SelBkkP7U+bknBVovX0CONetAMgjGGE6R4M6DuPM1ZYBXv8sfzRAyEBxphBqVA9/vUkLlXIN3jZ4wZ8C0BDRya24I3P52eKZRtBtyVdxus0LAz8oQDiLwOjyYLJlGIpGCrhhsyPQlIDChyTH36PQF6ovCkfkADh5RujCVpIIoo2gxo8gh/jK/f0HPymNbPg4tdJTG3FCv634TRMyiKtncgpWX1DELapwlj1yuUcs3AdOP7A3xBQ8/JExPGDIpj72bARJ4yKKRYM+CJTtsruYQxgXVGnqgn0JhBKv3IJQVbO/OYQf9phVaKH0D0lXPVD/O4Txp2Km3+ulBSsLVzKzPg9wmk9NN55AgzMGoHENtFdv66cm8RSFKwtXO7nkHzaNEbMLzkbWLMoEhNMwOSP4BojCC5jeOXFGztDJqBe4vosFvHGMKrMz8NTxOg0iUFG4AUMAOlkoINQAqYgVJJwQYgBZuBNNU2KBsp2ACkQM9AqaRgA5ACZqBUUrABSAEzUCop2ACkgBkolRRsAFLADJRKCjYAKWAGSiUFG4AUhZvBtt64U5xXi3olvIvsTYMeycPabuzsyQVPhNpKCrY2+LuB6MzFwTRm0deRMVV6S9FmEH5gxI3ZBNFtyzaP861Bk8f/IpFMZcFzH6zpGwWYQSEkvigMP0wa/FCpMReTB1OlFyf5gyNu/F1jps+Tw5mOjMK5CmhWo8Yt/PXLlRRsjWCq9P2hb8wgZ1KSxCxGMIPS6E8+gqnSp6HODLIac8IwYAYF4jX0SKMeNINgjOEEUWUG/N+ieTMhS4rcOjSCGZRJO5cBpkqfjgIzsI2bR38zJiXhuRMTtxEwg0LBVOm3RtdtQvNoMDZ3ITf0gfEEmEG5DM50NNQzCMFU6YUrMjjI05oNDSwawQzKZe9mwESeMihEnxkIjxxtj2BoLMEKZlAu85hB/2mFVso1g9jjwXA5/x6aJHUnmEG53MoMMFV6yT0DO3BI/6Fq1863G7usa/lNnlwnMIIZlMvtegbNo0VvwBBTpRck09jdKc75uwPHHPiWoU0L2fUWUv87U6m+IAVbO4NmIMSX2K1jDAFTpUPaJAUbgBQwA6WSgg1ACpiBUknBBiAFm4E01TYoGynYAKRAz0CppGADkAJmoFRSsAFIATNQKinYAKSAGSiVFGwAUsAMlEoKNgApYAZKJQUbgBTKzCDv9WN6jTlnivWSJQVbG/zdQHTm4mAas+jryJgqveU0egb05aIzl4H9pNmZ20CYYr10ScHWR+KLwvDDpMEPlRpzMXkwVbpahXMe9uc7IGn5WrGVFGyNYKr0/aHfDHKmTifl5itEUrB10p98BFOlT0O9GdDnyTkXfPQMCsZr6JFGPWgGwRjDCaLbDIKxgpjyplgvS1KwNdPOZYCp0qej2gzoah+f5WjcFOulSQq2ajBV+q1RbAbU2DPnPhyYYr1EScHWzuBMR0M9gxBMla5EmbcIncKJVAuXFGzt7N0MmMhTBoWoNYPxA4LyI8dSJQVbO/OYQf9phVbUmgE9RRC7/bEeAHoGxXMrM8BU6brNQO4YNNOnm8TOKnpTrJcvKdjauV3PoHm06A0YYqp0BQrfOgxl0pNTrJcvKdjaGTSDLt4+u3WMIWCqdEibpGADkAJmoFRSsAFIATNQKinYAKRgM5Cm2gZlIwUbgBToGSgVGQIEjRHMQKlgBtBYwQyUCmYAjRXMQKlgBtA41fX/AUq8HAtpBvKNAAAAAElFTkSuQmCC"></p><p>The experiment results show:</p><ol><li>GPS home position can be set successfully with these EKF2 settings.</li><li>In the indoor environment with GPS relay, GPS signal is stable and strong.</li><li>GPS module works well indoors</li></ol><p>Then the drone platform was tested outdoor.</p><p>Test Results:</p><p><img src="/tech-details/assets/images/ODGl-b74531290bccb038d640a1abb06f3fc4.png"></p><p>According to the results:</p><ol><li>GPS Green Light is not depends on the EKF2 settings</li><li>The firmware keeps checking GPS status, it will turn on the green light until the GPS status stabilizes for a while</li></ol><p><strong>Next step is to solve the errors shown in the test results:</strong></p><p>When the green light does not turn on, we can look at the flight log to see the exact problems the drone is facing.</p><p><strong>estimator_status_0.gps_check_fail_flags</strong> is an important indicator to show the error.
<img src="/tech-details/assets/images/gpsflag-b118ad991bea27c91526dee750916432.png"></p><p>From the graph, we can see the value changed to 256 at around 14.2s ~ 14.4s.</p><p>Error Code = 256 indicates 9th bit of gps_check_fail_flag is &#x27;True&#x27;. </p><p>Which also means GPS_CHECK_FAIL_MAX_HORZ_SPD_ERR = 1</p><p>So, we need to check GPS horizontal speed to see if there is something wrong with it.</p><p><strong>ekd_gps_drift_0.hspd</strong> is the parameter to check GPS horizontal speed.
<img src="/tech-details/assets/images/hspd-e9b4b2aa95d4a4ed94484c0a90dfb385.png"></p><p>The graph shows gps_drift horizontal speed value. </p><p>Let&#x27;s zoom it to see what happened between 14s ~ 15s
<img src="/tech-details/assets/images/hspzm-5e82b0da32df1ed91c489f781177c2a3.png"></p><p>Based on the zoomed graph, the speed exceeded 0.1m/s at around 14.2s</p><p>This verifies that the indicator is correct. </p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion-and-solution"></a>Conclusion and solution<a class="hash-link" href="#conclusion-and-solution" title="Direct link to heading">#</a></h4><p>According to the experiment and verification by using Fligh log, the default setting for gps horizontal speed check(0.1m/s) is too strict for outdoor testing. To solve this problem, the value can be increased to <strong>0.5m/s</strong>. This value is set based on the experience from previous experiments.</p><p>The figure below shows a successful experiment after adjusting the GPS parameters.
<img src="/tech-details/assets/images/2910test-264d35923b47e2ac6ee4883669b3fe91.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gps-test-without-shielding-box"></a>GPS Test without shielding box<a class="hash-link" href="#gps-test-without-shielding-box" title="Direct link to heading">#</a></h3><p><img src="/tech-details/assets/images/rstvitest-3fc1d7a5fe2dc10b078e3b0c175ceb12.png"></p><p>The graph above shows the roadmap for GPS test without shielding box. The data shown below can be found from this <a target="_blank" href="/tech-details/assets/files/12_40_29-4f14eb9c4725a3f30052ce91746b7c97.ulg/">Flight Log</a></p><p>The aim of this test is to check whether the vision system will affect GPS to start fusion.</p><p><img src="/tech-details/assets/images/rstvi-03c2481c70110e7c00d8be0f380602f2.png"></p><p>According to <strong>estimator_status_0.gps_check_fail_flags</strong>, the gps green light could not turn on at the begining. Then we swtich off the vision system at around 220, the value drop to 0. After about 10 seconds, <strong>vhicle_local_position_0.xy_global</strong> changed from 0 to 1. This indicates the green light turned on. After a while, the vision system has been restarted manually. </p><p><strong>In conclusion, the gps will be affected with out shielding TX2.</strong></p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="other-findings"></a>Other findings<a class="hash-link" href="#other-findings" title="Direct link to heading">#</a></h4><p>From the Roadmap graph, we can see there is a drift in estimated path. And from the odometry velocity log, there is also a drift at around 5.30</p><p><img src="/tech-details/assets/images/viodemvel-134468587dc5a9011da0f0a091e98e02.png"></p><p>We can also find the log message of this problem at 5.27.
<img src="/tech-details/assets/images/rstvilogmsg-31900c6edfcf02a8c06627389e75c7c8.png"></p><p>This shows that when vision signal is weak or unavailable, EKF2 will use GPS signal instead. </p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="pure-gps-base-navigation-log-16-nov-2020"></a>Pure GPS-base Navigation Log (16 Nov 2020)<a class="hash-link" href="#pure-gps-base-navigation-log-16-nov-2020" title="Direct link to heading">#</a></h3><p><img src="/tech-details/assets/images/pure-gps-fusion-725e1d71e330f83912c3c3b1c1adc069.png">
<a target="_blank" href="/tech-details/assets/files/07_47_15-581d3a7199e0c854c5dbdf1882913774.ulg/">Flight Log</a>
<a href="https://review.px4.io/plot_app?log=a8854114-b734-44e8-a065-5d1e57c354e9" target="_blank" rel="noopener noreferrer">Visualisation</a></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="25-nov-2020-settings-verification-test"></a>25 Nov 2020 (Settings Verification Test)<a class="hash-link" href="#25-nov-2020-settings-verification-test" title="Direct link to heading">#</a></h3><p>Some key settings of the drone:</p><ol><li>TX2 and wires are not covered by shelter</li><li>Firmware: PX4 fmu-v3_default</li><li>VIO &amp; GPS fusion</li></ol><p>Test Result:
<img src="/tech-details/assets/images/1125gps-2669900a24f6e381e0983cc99e3838fd.png">
<img src="/tech-details/assets/images/1125fusion-66241ab40f8c20cdcbee2cfe7204bd16.png">
<img src="/tech-details/assets/images/1125logmsg-53bf86d7178aa633c3510d6a6aa0f2fa.png">
The data log shown above can be found from this <a target="_blank" href="/tech-details/assets/files/05_24_56-4bf375120541774caa7aee3db86bd894.ulg/">Flight Log</a></p><p>Observation:</p><ol><li>Without shielding box, GPS module has a bad performance.</li><li>Yaw fusion is not accurate because of magnetometer.</li><li>According to log file, GPS signal can be received at 5Hz continously.</li></ol><p>Next step:
3 tests with same route will be conducted.</p><ol><li>Stop the vision program, only use GPS fusion</li><li>Put shielding box on the drone. </li><li>Turn off GPS from fusion.</li></ol><p>From test 1 and test(25/11), we will see how much influence that vision progam can make to GPS module.
Test 2 will show the performance of shielding box.
Test 3 will verify the accuracy of the vision program.</p></div><footer class="row docusaurus-mt-lg"><div class="col"></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-08-14T16:02:32.000Z">8/14/2021</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-initialisation/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« ECL EKF Initialisation</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ECL EKF Yaw Fusion Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#coordinate-systems-in-use-for-fusion" class="table-of-contents__link">Coordinate Systems in Use for Fusion</a><ul><li><a href="#mavros-conversion" class="table-of-contents__link">Mavros Conversion</a></li><li><a href="#px4-mavlink-receiver" class="table-of-contents__link">PX4 MAVLink Receiver</a></li><li><a href="#px4-ekf2-external-vision-data-processing" class="table-of-contents__link">PX4 EKF2 External Vision Data Processing</a></li><li><a href="#position--velocity-fusion-logics" class="table-of-contents__link">Position / Velocity Fusion Logics</a></li></ul></li><li><a href="#gps-usage-in-ekf" class="table-of-contents__link">GPS Usage in EKF</a><ul><li><a href="#10-oct-2020-local-position-estimate--green-light" class="table-of-contents__link">10 Oct 2020 (Local Position Estimate &amp; Green Light):</a></li></ul></li><li><a href="#ekf-debugging" class="table-of-contents__link">EKF Debugging</a><ul><li><a href="#ekf-status" class="table-of-contents__link">EKF Status</a></li><li><a href="#ekf2run-in-modulesekf2ekf2_maincpp" class="table-of-contents__link"><code>Ekf2::Run()</code> in <code>modules/ekf2/ekf2_main.cpp</code></a></li><li><a href="#ekfupdate-in-libeclekfcontrolcpp" class="table-of-contents__link"><code>Ekf::update()</code> in <code>lib/ecl/EKF/control.cpp</code></a></li></ul></li><li><a href="#about-gps-and-external-vision-fusion" class="table-of-contents__link">About GPS and External Vision Fusion</a><ul><li><a href="#29-oct-2020-experiment-of-gps-green-light-issue" class="table-of-contents__link">29 Oct 2020 (Experiment of GPS Green light issue)</a></li><li><a href="#gps-test-without-shielding-box" class="table-of-contents__link">GPS Test without shielding box</a></li><li><a href="#pure-gps-base-navigation-log-16-nov-2020" class="table-of-contents__link">Pure GPS-base Navigation Log (16 Nov 2020)</a></li><li><a href="#25-nov-2020-settings-verification-test" class="table-of-contents__link">25 Nov 2020 (Settings Verification Test)</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc1/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 TSL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/tech-details/assets/js/runtime~main.fa9cdf7e.js"></script>
<script src="/tech-details/assets/js/main.0141e7f4.js"></script>
</body>
</html>