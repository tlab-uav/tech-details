<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/tech-details/blog/rss.xml" title="117411 TSL UAV Tech Details Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tech-details/blog/atom.xml" title="117411 TSL UAV Tech Details Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"><title data-react-helmet="true">ECL EKF Yaw Fusion Logics | 117411 TSL UAV Tech Details</title><meta data-react-helmet="true" property="og:url" content="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="ECL EKF Yaw Fusion Logics | 117411 TSL UAV Tech Details"><meta data-react-helmet="true" name="description" content="Yaw fusion come from two sensor sources: magnetometer and GPS."><meta data-react-helmet="true" property="og:description" content="Yaw fusion come from two sensor sources: magnetometer and GPS."><link data-react-helmet="true" rel="shortcut icon" href="/tech-details/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/" hreflang="x-default"><link rel="stylesheet" href="/tech-details/assets/css/styles.032a5ccc.css">
<link rel="preload" href="/tech-details/assets/js/runtime~main.73c2a861.js" as="script">
<link rel="preload" href="/tech-details/assets/js/main.0a2ae1d5.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Hardware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Jetson TX2</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started/">Jetson Xavier NX</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/cameras/tiscamera-install/">Cameras</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">PX4 Firmware</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview/">UAV Platform</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/systems/vicon/">Systems</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/systems/ros-coordinate-systems/">ROS Coordinate Systems</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/unity-simulator/">Simulations</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/vicon/">Vicon</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/pixhawk/getting-started/">Pixhawk Platform</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/pixhawk_v1/pixhawk/">Past Platforms : pixhawk v1</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/SAFMC/">SAFMC Drone Buildup</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions/">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/linux/getting-started/overview/">Getting Started</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/packages/file-systems/">Software Packages</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/ros/using-catkin-build/">ROS</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/kernel/grub-default-kernel/">Drivers &amp; Kernel</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/productivity/git/git/">Productivity</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/productivity/git/git/">Git Version Control</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/cmake_debug/cmake/">CMake and Debugging</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/uiux/pangolin/">UI/UX Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Research</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Flight Data</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/calibration/getting-started/">Sensor Calibration</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/collision-avoidance/overview-problems/">Collision Avoidance</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/vio/basalt-overview/">VIO</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/edt/edt-overview/">EDT</a></li></ul></div><a class="navbar__item navbar__link" href="/tech-details/docs/examples/doc0/">Examples (To Edit)</a><a class="navbar__item navbar__link" href="/tech-details/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" role="button" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Hardware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Jetson TX2</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started/">Jetson Xavier NX</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/cameras/tiscamera-install/">Cameras</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">PX4 Firmware</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview/">UAV Platform</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/systems/vicon/">Systems</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/ros-coordinate-systems/">ROS Coordinate Systems</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/unity-simulator/">Simulations</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/vicon/">Vicon</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/pixhawk/getting-started/">Pixhawk Platform</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/pixhawk_v1/pixhawk/">Past Platforms : pixhawk v1</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/SAFMC/">SAFMC Drone Buildup</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions/">Linux</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/getting-started/overview/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/packages/file-systems/">Software Packages</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/ros/using-catkin-build/">ROS</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/kernel/grub-default-kernel/">Drivers &amp; Kernel</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/productivity/git/git/">Productivity</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/git/git/">Git Version Control</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/cmake_debug/cmake/">CMake and Debugging</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/uiux/pangolin/">UI/UX Tools</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Research</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Flight Data</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/calibration/getting-started/">Sensor Calibration</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/collision-avoidance/overview-problems/">Collision Avoidance</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/vio/basalt-overview/">VIO</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/edt/edt-overview/">EDT</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/examples/doc0/">Examples (To Edit)</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/blog/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">PX4 Firmware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-toolchain-installation-setup/">Toolchain Installation &amp; Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-log-analysis/">Log Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-sitl/">PX4 SITL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-control-structure/">PX4 Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/mavlink-imu/">MAVLink IMU Topics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/time-synchronisation/">About Time Synchronisation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-camera-trigger/">Hardware Camera Trigger</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-dynamic-control-allocation/">PX4 Dynamic Control Allocation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/px4-FAQ/">PX4 FAQ</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">ECL EKF</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-ekf/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-initialisation/">ECL EKF Initialisation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/">ECL EKF Sensor Fusion (GPS)</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/">ECL EKF Yaw Fusion</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-state-reset/">ECL EKF State Reset Logics</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">ECL EKF Yaw Fusion Logics</h1></header><p>Yaw fusion come from two sensor sources: magnetometer and GPS.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="magnetometer-yaw-fusion"></a>Magnetometer Yaw Fusion<a class="hash-link" href="#magnetometer-yaw-fusion" title="Direct link to heading">#</a></h2><p>The type of fusion is controlled by the px4 parameter <code>mag_fusion_type</code> in code or equivalently <code>EKF2_MAG_TYPE</code> in parameter name.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">/**</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Type of magnetometer fusion</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> *</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * Integer controlling the type of magnetometer fusion used - magnetic heading or 3-component vector. The fuson of magnetomer data as a three component vector enables vehicle body fixed hard iron errors to be learned, but requires a stable earth field.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;Automatic&#x27; magnetic heading fusion is used when on-ground and 3-axis magnetic field fusion in-flight with fallback to magnetic heading fusion if there is insufficient motion to make yaw or magnetic field states observable.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;Magnetic heading&#x27; magnetic heading fusion is used at all times</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;3-axis&#x27; 3-axis field fusion is used at all times.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;VTOL custom&#x27; the behaviour is the same as &#x27;Automatic&#x27;, but if fusing airspeed, magnetometer fusion is only allowed to modify the magnetic field states. This can be used by VTOL platforms with large magnetic field disturbances to prevent incorrect bias states being learned during forward flight operation which can adversely affect estimation accuracy after transition to hovering flight.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;MC custom&#x27; the behaviour is the same as &#x27;Automatic, but if there are no earth frame position or velocity observations being used, the magnetometer will not be used. This enables vehicles to operate with no GPS in environments where the magnetic field cannot be used to provide a heading reference. Prior to flight, the yaw angle is assumed to be constant if movement tests controlled by the EKF2_MOVE_TEST parameter indicate that the vehicle is static. This allows the vehicle to be placed on the ground to learn the yaw gyro bias prior to flight.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * If set to &#x27;None&#x27; the magnetometer will not be used under any circumstance. If no external source of yaw is available, it is possible to use post-takeoff horizontal movement combined with GPS velocity measurements to align the yaw angle with the timer required (depending on the amount of movement and GPS data quality). Other external sources of yaw may be used if selected via the EKF2_AID_MASK parameter.</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @group EKF2</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 0 Automatic</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 1 Magnetic heading</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 2 3-axis</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 3 VTOL custom</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 4 MC custom</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @value 5 None</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> * @reboot_required true</span></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">PARAM_DEFINE_INT32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">EKF2_MAG_TYPE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The default <code>automatic</code> mode may not be suitable for indoor-outdoor transition, as the fusion always use magnetometer readings in flight.</p><p>The main logics is written in <code>controlMagFusion()</code> within file <code>mag_control.cpp</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="mag_fuse_type_none"></a><code>MAG_FUSE_TYPE_NONE</code><a class="hash-link" href="#mag_fuse_type_none" title="Direct link to heading">#</a></h3><p>The magnetometer is only used pre-flight, for gyro bias estimation.</p><p>This mode should be used, if we do not want to have yaw drift, when we perform indoor-outdoor transitions</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="mag_fuse_type_indoor-aka-mc-custom"></a><code>MAG_FUSE_TYPE_INDOOR</code> aka <code>MC custom</code><a class="hash-link" href="#mag_fuse_type_indoor-aka-mc-custom" title="Direct link to heading">#</a></h3><p>This mode will inhibit yaw fusion (<code>_is_yaw_fusion_inhibited</code> sets to true), only if GPS and Vision position / velocity fusion is not used. In our use case, the mode has no practical use.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="2611-tests"></a>26/11 Tests<a class="hash-link" href="#2611-tests" title="Direct link to heading">#</a></h3><p>4 tests were conducted to test different combinations of magnetometer settings and vision .</p><ol><li>MC custom &amp; Vision OFF</li><li>MC custom &amp; Vision ON</li><li>None &amp; Vision OFF</li><li>None &amp; Vision ON</li></ol><p>Tests Results:</p><ol><li><p>Test 1 <a href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/MCGps.ulg/">MC custom &amp; Vision OFF</a>
<img src="/tech-details/assets/images/MCGPS-7499bac0d7f099fb62dd145b952e625a.png">
<img src="/tech-details/assets/images/MCGPSLOG-0095a4212b290248a2622964c2dd5a30.png"></p></li><li><p>Test 2 <a href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/MCVision.ulg/">MC custom &amp; Vision ON</a>
<img src="/tech-details/assets/images/MCVision-4213e0e039bcf07212ce53364f813f3b.png">
<img src="/tech-details/assets/images/MCVisionlog-ecb106c1338addbc3c9e43b8e7533d62.png"></p></li><li><p>Test 3 <a href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/NONEGps.ulg/">None &amp; Vision OFF</a>
<img src="/tech-details/assets/images/NoneGPS-5eb2f4772edd6c5b45266f6b15785a76.png">
<img src="/tech-details/assets/images/NONEGPSLOG-2bbb5a8a27296f29fd9595c6645e6a8e.png"></p></li><li><p>Test 4 <a href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/NONEVision.ulg/">None &amp; Vsion ON</a>
<img src="/tech-details/assets/images/NONEVision-3ab5d8c8934fd3ed0ac5fe37536a5123.png">
<img src="/tech-details/assets/images/NONEVisionLog-865553ab1852f5fe892ec95902d47c94.png"></p></li></ol><p>Observations:</p><p>There is still a yaw drift. EKF2 fusion setting is 321 for these 4 tests. To include GPS yaw fusion, the setting should be changed to 450.</p></div><footer class="row docusaurus-mt-lg"><div class="col"></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-08-14T16:02:32.000Z">8/14/2021</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« ECL EKF Sensor Fusion (GPS)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-state-reset/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ECL EKF State Reset Logics Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#magnetometer-yaw-fusion" class="table-of-contents__link">Magnetometer Yaw Fusion</a><ul><li><a href="#mag_fuse_type_none" class="table-of-contents__link"><code>MAG_FUSE_TYPE_NONE</code></a></li><li><a href="#mag_fuse_type_indoor-aka-mc-custom" class="table-of-contents__link"><code>MAG_FUSE_TYPE_INDOOR</code> aka <code>MC custom</code></a></li><li><a href="#2611-tests" class="table-of-contents__link">26/11 Tests</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc1/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 TSL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/tech-details/assets/js/runtime~main.73c2a861.js"></script>
<script src="/tech-details/assets/js/main.0a2ae1d5.js"></script>
</body>
</html>