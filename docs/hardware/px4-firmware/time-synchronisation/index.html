<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/tech-details/blog/rss.xml" title="117411 TSL UAV Tech Details Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tech-details/blog/atom.xml" title="117411 TSL UAV Tech Details Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"><title data-react-helmet="true">FCU-OBC Time Synchronisation | 117411 TSL UAV Tech Details</title><meta data-react-helmet="true" property="og:url" content="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/time-synchronisation/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="FCU-OBC Time Synchronisation | 117411 TSL UAV Tech Details"><meta data-react-helmet="true" name="description" content="Motivation - Sensor Data Correspondence"><meta data-react-helmet="true" property="og:description" content="Motivation - Sensor Data Correspondence"><link data-react-helmet="true" rel="shortcut icon" href="/tech-details/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/time-synchronisation/"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/time-synchronisation/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/time-synchronisation/" hreflang="x-default"><link rel="stylesheet" href="/tech-details/assets/css/styles.032a5ccc.css">
<link rel="preload" href="/tech-details/assets/js/runtime~main.7c8743a0.js" as="script">
<link rel="preload" href="/tech-details/assets/js/main.2f7f23fc.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Hardware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Jetson TX2</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started/">Jetson Xavier NX</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/cameras/tiscamera-install/">Cameras</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">PX4 Firmware</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview/">UAV Platform</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/systems/vicon/">Systems</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/systems/ros-coordinate-systems/">ROS Coordinate Systems</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/unity-simulator/">Simulations</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/vicon/">Vicon</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/pixhawk/getting-started/">Pixhawk Platform</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/pixhawk_v1/pixhawk/">Past Platforms : pixhawk v1</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/SAFMC/">SAFMC Drone Buildup</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/Crazyflie/">Crazyflie</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions/">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/linux/getting-started/overview/">Getting Started</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/packages/file-systems/">Software Packages</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/ros/using-catkin-build/">ROS</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/kernel/grub-default-kernel/">Drivers &amp; Kernel</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/productivity/git/git/">Productivity</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/productivity/git/git/">Git Version Control</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/cmake_debug/cmake/">CMake and Debugging</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/uiux/pangolin/">UI/UX Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Research</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Flight Data</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/calibration/getting-started/">Sensor Calibration</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/collision-avoidance/overview-problems/">Collision Avoidance</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/vio/basalt-overview/">VIO</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/edt/edt-overview/">EDT</a></li></ul></div><a class="navbar__item navbar__link" href="/tech-details/docs/examples/doc0/">Examples (To Edit)</a><a class="navbar__item navbar__link" href="/tech-details/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" role="button" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Hardware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Jetson TX2</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started/">Jetson Xavier NX</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/cameras/tiscamera-install/">Cameras</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">PX4 Firmware</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview/">UAV Platform</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/systems/vicon/">Systems</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/ros-coordinate-systems/">ROS Coordinate Systems</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/unity-simulator/">Simulations</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/vicon/">Vicon</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/pixhawk/getting-started/">Pixhawk Platform</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/pixhawk_v1/pixhawk/">Past Platforms : pixhawk v1</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/SAFMC/">SAFMC Drone Buildup</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/Crazyflie/">Crazyflie</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions/">Linux</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/getting-started/overview/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/packages/file-systems/">Software Packages</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/ros/using-catkin-build/">ROS</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/kernel/grub-default-kernel/">Drivers &amp; Kernel</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/productivity/git/git/">Productivity</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/git/git/">Git Version Control</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/cmake_debug/cmake/">CMake and Debugging</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/uiux/pangolin/">UI/UX Tools</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Research</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Flight Data</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/calibration/getting-started/">Sensor Calibration</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/collision-avoidance/overview-problems/">Collision Avoidance</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/vio/basalt-overview/">VIO</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/edt/edt-overview/">EDT</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/examples/doc0/">Examples (To Edit)</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/blog/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">PX4 Firmware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-toolchain-installation-setup/">Toolchain Installation &amp; Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-log-analysis/">Log Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-sitl/">PX4 SITL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-control-structure/">PX4 Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/mavlink-imu/">MAVLink IMU Topics</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/time-synchronisation/">About Time Synchronisation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-camera-trigger/">Hardware Camera Trigger</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-dynamic-control-allocation/">PX4 Dynamic Control Allocation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-FAQ/">PX4 FAQ</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ECL EKF</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-ekf/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-initialisation/">ECL EKF Initialisation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/">ECL EKF Sensor Fusion (GPS)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/">ECL EKF Yaw Fusion</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-state-reset/">ECL EKF State Reset Logics</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">FCU-OBC Time Synchronisation</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="motivation---sensor-data-correspondence"></a>Motivation - Sensor Data Correspondence<a class="hash-link" href="#motivation---sensor-data-correspondence" title="Direct link to heading">#</a></h2><p>PX4-based flight controller boards (FCU), such as Pixhawk series, have rich I/O interfaces, and at the same time provides a real-time operating system environment (POSIX-compliant Nuttx specifically). These capabilities enables us to have real-time guarantees, when interfacing any sensors that are time-critical.</p><p>The necessity of time synchronisation comes into play due to the following facts:</p><ol><li>The flight controller board (FCU) and the on-board computer (OBC) operates on different hardware clocks (typically its respective boot time, in nanoseconds);</li><li>Sensor data reception is physically distributed: some sensor data (e.g. built-in IMU) is received by the FCU, while others (e.g. cameras) are received by the OBC;</li><li>Tight-coupled sensor fusion algorithm requires precise time correspondence of all sensor inputs involved, to perform inference on the state of the agent.</li></ol><p>One particular use case is to operate multiple cameras in a hardware-synchronised fashion, with a master IMU module sending electrical triggering signal. We are interested in determining the correspondence between all incoming image streams and the triggering IMU measurement.</p><p>The solution is non-trivial as IMU measurement is taken with a timestamp in <strong>FCU-time domain</strong>, whereas the image reception (either over MIPI or USB data link) is timestamped in <strong>OBC-time domain</strong>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="doing-without-time-synchronisation"></a>Doing Without Time Synchronisation<a class="hash-link" href="#doing-without-time-synchronisation" title="Direct link to heading">#</a></h2><p>It is technically possible to determine correspondence without any time synchronisation, but with a few necessary assumptions. In this setting, we need to assume:</p><ul><li>All sensor data to establish correspondence are strictly triggered by the same physical event (CPU instruction, electrical signal), up to the precision required (often sub-millisecond);</li><li>The communication delays of respective sensor data <strong>to OBC</strong> are predicable / consistent;</li><li>The sensor data is gathered by OBC, and the sensor fusion algorithms are only carried out on OBC. In this way, we could perform all processing in <strong>OBC-time domain</strong>;</li><li>The OBC has close to realtime scheduling performance. (This is where things may break, particularly under high CPU load)</li></ul><p>Fortunately, this is often the case. Lets do some quick maths in the case of IMU-Cameras data correspondence.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="correspondance-with-known-latency-and-sampling-period"></a>Correspondance with Known Latency and Sampling Period<a class="hash-link" href="#correspondance-with-known-latency-and-sampling-period" title="Direct link to heading">#</a></h3><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="latency-for-imu-data-over-uart"></a>Latency for IMU Data over UART<a class="hash-link" href="#latency-for-imu-data-over-uart" title="Direct link to heading">#</a></h4><p>Typically, IMU data is transmitted over UART protocol from FCU / dedicated IMU to the OBC. The typical baud rate we have is 921600bps, which is ~90KB per second, which in turn is <strong>90 byte per millisecond</strong>. It is typically safe to assume each IMU packet is less than a 100 byte, therefore the communication delay induced by the physical UART layer is about $t_{UART} \approx 1$ ms. In reality, this number is still in the range of very few milliseconds (depending on the pulling rate of the OS; In Linux low-latency mode, the rate is about 1ms).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="latency-for-image-data-over-usb30"></a>Latency for Image Data over USB3.0<a class="hash-link" href="#latency-for-image-data-over-usb30" title="Direct link to heading">#</a></h4><p>On the other hand, one image data frame is much much larger than an imu data frame. A 1-megapixel 16-bit raw image would give rise to a data size of 2MB. Provided a USB3.0 physical layer connection has a bandwidth of 5Gbit/s, the communication delay over USB is $t_{USB} \approx \frac{8*2}{5} = 3.4$ ms. In reality, the delay could be in terms of $10$ ms or more, heavily <strong>depends on how many devices</strong> present on the USB bus streaming.</p><p>Putting into context, with a 20Hz rate of IMU-cameras correspondence frequency, the data correspondence happens every 50ms or so. Therefore, we could infer the IMU-cameras correspondence by just looking at the time of arrival (TOA) at OBC side. Why is that the case?</p><ol><li>Camera data is almost surely (we will see when this is not the case soon) arrived after IMU data, because of the communication delays;</li><li>Compared to the 50ms sampling period in between each IMU-camera correspondence event, the expected slack time between the TOA of camera data and TOA of IMU data is much less, $10ms &lt; 50ms$. This ensures that we do not have ambiguity of having camera data &#x27;diffusing&#x27; into the next IMU-camera event. (We may term this as <strong>aliasing</strong>)</li></ol><p>In summary, the good stuff here is that we have the <strong>slack time</strong> (between IMU data and camera data) predicable and less than the <strong>sampling period</strong>. We could use a trivial algorithm to match the camera data to the closest IMU data which is <em>strictly earlier</em> in OBC-time domain.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="potential-issues-working-without-time-synchronisation"></a>Potential Issues Working without Time Synchronisation<a class="hash-link" href="#potential-issues-working-without-time-synchronisation" title="Direct link to heading">#</a></h3><p><strong>Pros</strong>:</p><ul><li>No software architectural dependency outside OBC</li></ul><p><strong>Cons</strong>:</p><ul><li>All sensor data need to be triggered by the same physical event, and the precise timing of that event cannot be determined precisely (can only be estimated based on the communication delays etc.)</li><li>Case-by-case analysis needed</li><li>Non-realtime operating system may cause jittering which corrupts the correspondence</li><li>Subject to system CPU loading and other resource constraints</li></ul><p>The obvious advantage of this no-synchornisation approach is that there is no dependency outside the OBC, as we disregard all other time domains, and only work on time of arrival timings in the OBC-time domain.</p><p>However, as we have seen, the correctness of such approach need to be analysed case-by-case: the nature of the communication channels, the data size, the time period of each correspondence event. All those piece must be compatible to make inference of correspondance work. Otherwise, issues like aliasing may happen.</p><p><strong>Known issue</strong>: In not-so rare cases, camera data may arrive to OBC earlier than the triggering. This may caused by multiple factors, such as the USB kernel was allocated the right time to transmit the data over, while the UART kernel is stucked waiting for scheduling. I would like to term this effect as <strong>jitter</strong>, as this normally have something to do on how the OS schedule kernel tasks.</p><p>In addition, there is no way to know the actual time that the correspondence is happening, which hides behind the non-deterministic communication delay, buffering delay etc.</p><p>For a reference on how the implementation may look like for a IMU-Camera synchronisation, without assuming time synchronisation, refer here <a href="https://github.com/chengguizi/tiscamera_ros/blob/master/include/camera_imu_sync.hpp" target="_blank" rel="noopener noreferrer">camera_imu_sync.cpp</a>.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="doing-time-synchronisation-using-mavlink"></a>Doing Time Synchronisation using MAVLink<a class="hash-link" href="#doing-time-synchronisation-using-mavlink" title="Direct link to heading">#</a></h2><p> The more elaborated and proper way to achieve time synchronisation of different sensor data in different time-domain is discussed below.</p><p>In the platform we used, an implementation has been done using MAVLink protocol, implemented in both PX4 Firmware and Mavros package.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="working-principle-reference"></a>Working Principle (<a href="https://github.com/mavlink/mavlink-devguide/issues/194" target="_blank" rel="noopener noreferrer">Reference</a>)<a class="hash-link" href="#working-principle-reference" title="Direct link to heading">#</a></h3><p>The host (both side CAN be the host at the SAME time) sends a <a href="https://mavlink.io/en/messages/common.html#TIMESYNC" target="_blank" rel="noopener noreferrer">TIMESYNC message</a>, which contain two fields <code>tc1</code> (filled with zero) and <code>ts1</code>(filled with current hardware time in nanoseconds). </p><p>As the receiver, when a TIMESYNC message is received, there are two cases:</p><ul><li><code>tc1</code> == 0, then the message just make a half-round trip. The receiver sends back <code>tc1</code> filled with its own current hardware timestamp in nanoseconds, and the original <code>ts1</code> field</li><li><code>tc1</code> != 0, then the message has made the full round trip. Then the current hardware time subtracted by the <code>ts1</code> field will give the round trip time, and tc1 - (current time + <code>ts1</code>) / 2 will give the offset.</li></ul><p>The logics are both implemented in mavros (<code>sys_time.cpp</code>) and in PX4 firmware. On mavros, the estimation is availalbe at topic <code>/mavros/timesync_status</code>, like example below:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><pre tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">header</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">seq</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">172</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">stamp</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">secs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1013</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">nsecs</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">301973092</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">frame_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">remote_timestamp_ns</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">35922878000</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">observed_offset_ns</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">977378604936</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">estimated_offset_ns</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">977378507661</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">round_trip_time_ms</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.979619979858</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="synchronising-timestamp"></a>Synchronising Timestamp<a class="hash-link" href="#synchronising-timestamp" title="Direct link to heading">#</a></h3><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The content below is based on the modified version of <a href="https://github.com/chengguizi/mavros/tree/monotonic" target="_blank" rel="noopener noreferrer">mavros</a>.</p><p>The original mavros only allows the time synchronisation to be performed against OBC&#x27;s realtime clock (Wallclock / UNIX Time). This is potentially problematic for us, as realtime clock can jump, whenever a NTP timesync happens over the network.</p><p><code>clock_source: monotonic # realtime (ros::Time::now()) or monotonic (MONOTOMIC_TIME)</code> option has been added to allow mavros to track against monotonic clock (hardware time) on the OBC, instead of the wallclock. (encapsulated in the <code>get_time_now()</code>)</p></div></div><p>To turn on time synchronisation, just set the <code>timesync_mode</code> option to be <code>MAVLINK</code>, and <code>clock_source</code> to be <code>monotonic</code>. When <code>mavros</code> first starts up, it requires <strong>tens of seconds</strong> to stabilise the estimation. A info prompt will be shown after the synchronisation estimate has been completed.</p></div><footer class="row docusaurus-mt-lg"><div class="col"></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-08-14T16:02:32.000Z">8/14/2021</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tech-details/docs/hardware/px4-firmware/mavlink-imu/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« MAVLink IMU Topics</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tech-details/docs/hardware/px4-firmware/px4-camera-trigger/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Hardware Camera Trigger Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#motivation---sensor-data-correspondence" class="table-of-contents__link">Motivation - Sensor Data Correspondence</a></li><li><a href="#doing-without-time-synchronisation" class="table-of-contents__link">Doing Without Time Synchronisation</a><ul><li><a href="#correspondance-with-known-latency-and-sampling-period" class="table-of-contents__link">Correspondance with Known Latency and Sampling Period</a></li><li><a href="#potential-issues-working-without-time-synchronisation" class="table-of-contents__link">Potential Issues Working without Time Synchronisation</a></li></ul></li><li><a href="#doing-time-synchronisation-using-mavlink" class="table-of-contents__link">Doing Time Synchronisation using MAVLink</a><ul><li><a href="#working-principle-reference" class="table-of-contents__link">Working Principle (Reference)</a></li><li><a href="#synchronising-timestamp" class="table-of-contents__link">Synchronising Timestamp</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc1/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 TSL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/tech-details/assets/js/runtime~main.7c8743a0.js"></script>
<script src="/tech-details/assets/js/main.2f7f23fc.js"></script>
</body>
</html>