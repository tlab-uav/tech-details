<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/tech-details/blog/rss.xml" title="117411 TSL UAV Tech Details Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tech-details/blog/atom.xml" title="117411 TSL UAV Tech Details Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"><title data-react-helmet="true">PX4 Dynamic Control Allocation | 117411 TSL UAV Tech Details</title><meta data-react-helmet="true" property="og:url" content="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/px4-dynamic-control-allocation/"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="PX4 Dynamic Control Allocation | 117411 TSL UAV Tech Details"><meta data-react-helmet="true" name="description" content="Introduction"><meta data-react-helmet="true" property="og:description" content="Introduction"><link data-react-helmet="true" rel="shortcut icon" href="/tech-details/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/px4-dynamic-control-allocation/"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/px4-dynamic-control-allocation/" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/hardware/px4-firmware/px4-dynamic-control-allocation/" hreflang="x-default"><link rel="stylesheet" href="/tech-details/assets/css/styles.032a5ccc.css">
<link rel="preload" href="/tech-details/assets/js/runtime~main.750cdc36.js" as="script">
<link rel="preload" href="/tech-details/assets/js/main.010924a9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Hardware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Jetson TX2</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started/">Jetson Xavier NX</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/cameras/tiscamera-install/">Cameras</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">PX4 Firmware</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview/">UAV Platform</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/systems/vicon/">Systems</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/systems/ros-coordinate-systems/">ROS Coordinate Systems</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/unity-simulator/">Simulations</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/vicon/">Vicon</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/pixhawk/getting-started/">Pixhawk Platform</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/pixhawk_v1/pixhawk/">Past Platforms : pixhawk v1</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/SAFMC/">SAFMC Drone Buildup</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/Crazyflie/">Crazyflie</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions/">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/linux/getting-started/overview/">Getting Started</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/packages/file-systems/">Software Packages</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/ros/using-catkin-build/">ROS</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/kernel/grub-default-kernel/">Drivers &amp; Kernel</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/productivity/git/git/">Productivity</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/productivity/git/git/">Git Version Control</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/cmake_debug/cmake/">CMake and Debugging</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/uiux/pangolin/">UI/UX Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Research</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Flight Data</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/calibration/getting-started/">Sensor Calibration</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/collision-avoidance/overview-problems/">Collision Avoidance</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/vio/basalt-overview/">VIO</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/edt/edt-overview/">EDT</a></li></ul></div><a class="navbar__item navbar__link" href="/tech-details/docs/examples/doc0/">Examples (To Edit)</a><a class="navbar__item navbar__link" href="/tech-details/blog/">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" role="button" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Hardware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image/">Jetson TX2</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started/">Jetson Xavier NX</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/cameras/tiscamera-install/">Cameras</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">PX4 Firmware</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview/">UAV Platform</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/systems/vicon/">Systems</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/ros-coordinate-systems/">ROS Coordinate Systems</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/unity-simulator/">Simulations</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/vicon/">Vicon</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/pixhawk/getting-started/">Pixhawk Platform</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/pixhawk_v1/pixhawk/">Past Platforms : pixhawk v1</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/SAFMC/">SAFMC Drone Buildup</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/Crazyflie/">Crazyflie</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions/">Linux</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/getting-started/overview/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/packages/file-systems/">Software Packages</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/ros/using-catkin-build/">ROS</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/kernel/grub-default-kernel/">Drivers &amp; Kernel</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/productivity/git/git/">Productivity</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/git/git/">Git Version Control</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/cmake_debug/cmake/">CMake and Debugging</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/uiux/pangolin/">UI/UX Tools</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Research</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/flight-data/flight-data-analysis/">Flight Data</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/calibration/getting-started/">Sensor Calibration</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/collision-avoidance/overview-problems/">Collision Avoidance</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/vio/basalt-overview/">VIO</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/edt/edt-overview/">EDT</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/examples/doc0/">Examples (To Edit)</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/blog/">Blog</a></li><li class="menu__list-item"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="menu__link"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">PX4 Firmware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-overview/">Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-toolchain-installation-setup/">Toolchain Installation &amp; Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-log-analysis/">Log Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-sitl/">PX4 SITL</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-control-structure/">PX4 Control</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/mavlink-imu/">MAVLink IMU Topics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/time-synchronisation/">About Time Synchronisation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-camera-trigger/">Hardware Camera Trigger</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-dynamic-control-allocation/">PX4 Dynamic Control Allocation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/hardware/px4-firmware/px4-FAQ/">PX4 FAQ</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">ECL EKF</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-ekf/">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-initialisation/">ECL EKF Initialisation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-sensor-fusion/">ECL EKF Sensor Fusion (GPS)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-yaw-fusion/">ECL EKF Yaw Fusion</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/hardware/px4-firmware/ecl-ekf/px4-ecl-state-reset/">ECL EKF State Reset Logics</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">PX4 Dynamic Control Allocation</h1></header><p><a href="https://www.youtube.com/watch?v=xjLM9whwjO4" target="_blank" rel="noopener noreferrer">https://www.youtube.com/watch?v=xjLM9whwjO4</a></p><p><a href="https://github.com/PX4/PX4-Autopilot/pull/13351" target="_blank" rel="noopener noreferrer">https://github.com/PX4/PX4-Autopilot/pull/13351</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="introduction"></a>Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">#</a></h2><p><img alt="control allocation" src="/tech-details/assets/images/PX4_High-Level_Flight-Stack-9fb7a6077604093aa03e0ac3d69e8f0d.svg"></p><p>Control allocation is a part of the PX4 system that computes the actuator commands from torque and thrust setpoints.</p><p>The old version of PX4 uses static mixing tables generated by mixers. A mixer uses the geometry of a vehicle to calculate an effectiveness matrix consisting of the force and torque generated by each actuator. Then the pseudo-inverse of the effectiveness matrix, aka the mixer matrix, is calculated. The mixer matrix can be multiplied with the moment and thrust setpoints to obtain the required actuator commands. All these works are done at compile time, therefore the mixing table cannot be modified during runtime. To achieve dynamic control allocation, we need to be able to change the mixing table at runtime.</p><p><img alt="control allocation" src="/tech-details/assets/images/ca_sequence-2e027c80bbf18981d56404abf257672f.png"></p><p>The new control_allocator module does so by calculating the effectiveness matrix and its inverse in the controller. Its input, torque and thrust setpoints, are calculated in the angular_velocity_controller module which uses mass and inertia parameters to get gains with physical units. It also reads parameters that indicate which rotors are disabled and updates the effectiveness matrix accordingly. To integrate these modules into the existing system, a direct mixer is used.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="overall-structure"></a>Overall Structure<a class="hash-link" href="#overall-structure" title="Direct link to heading">#</a></h2><details><summary><b>angular_velocity_controller</b></summary><ol><li>Calculate <strong>thrust_sp</strong><ul><li><strong>thrust_sp</strong> = thrust <em> vm_mass </em> G / hover_thrust</li></ul></li><li>Calculate <strong>torque_sp</strong><ul><li>angular_accel_sp = gain_p .<em> angular_velocity_error - gain_d .</em> angular_acceleration</li><li>torque_ff = angular_velocity_int + gain_ff .* angular_velocity_sp</li><li><strong>torque_sp</strong> = inertia <em> angular_accel_sp + torque_ff + angular_velocity x (inertia </em> angular_velocity)</li><li>angular_velocity_int = angular_velocity_int + i_factor <em> gain_i </em> angular_velocity_error * dt</li></ul></li><li>Publish <strong>thrust_sp</strong> and <strong>torque_sp</strong></li></ol><details><summary>Parameters</summary><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>AVC_*_P</td><td>Body * axis angular velocity P gain (unit 1/s)</td></tr><tr><td>AVC_*_I</td><td>Body * axis angular velocity I gain (unit Nm/rad)</td></tr><tr><td>AVC_*_D</td><td>Body * axis angular velocity D gain</td></tr><tr><td>AVC_*_I_LIM</td><td>Body * axis angular velocity integrator limit (unit Nm)</td></tr><tr><td>AVC_*_FF</td><td>Body * axis angular velocity feedforward gain (unit Nm/(rad/s))</td></tr><tr><td>AVC_*_K</td><td>Body * axis angular velocity controller global gain</td></tr><tr><td>VM_MASS</td><td>Mass (unit kg)</td></tr><tr><td>VM_INERTIA_XX</td><td>Inertia matrix, XX component (unit kg m^2)</td></tr><tr><td>VM_INERTIA_YY</td><td>Inertia matrix, YY component (unit kg m^2)</td></tr><tr><td>VM_INERTIA_ZZ</td><td>Inertia matrix, ZZ component (unit kg m^2)</td></tr><tr><td>VM_INERTIA_XY</td><td>Inertia matrix, XY component (unit kg m^2)</td></tr><tr><td>VM_INERTIA_XZ</td><td>Inertia matrix, XZ component (unit kg m^2)</td></tr><tr><td>VM_INERTIA_YZ</td><td>Inertia matrix, YZ component (unit kg m^2)</td></tr><tr><td>MPC_THR_HOVER</td><td>Hover thrust (Vertical thrust required to hover)</td></tr><tr><td>MPC_USE_HTE</td><td>Hover thrust source selector (Set false to use the fixed parameter MPC_THR_HOVER Set true to use the value computed by the hover thrust estimator) see <a href="https://github.com/PX4/PX4-Autopilot/pull/13981#issue-364553361" target="_blank" rel="noopener noreferrer">this PR for details</a></td></tr></tbody></table><p>Reference: <a href="https://docs.px4.io/master/en/advanced_config/parameter_reference.html#angular-velocity-control" target="_blank" rel="noopener noreferrer">https://docs.px4.io/master/en/advanced_config/parameter_reference.html#angular-velocity-control</a></p></details><details><summary>uORB Subscriptions</summary><table><thead><tr><th>Topic</th><th>Description</th></tr></thead><tbody><tr><td>control_allocator_status</td><td><code>torque_setpoint_achieved</code>, <code>unallocated_torque[3]</code></td></tr><tr><td>vehicle_angular_acceleration</td><td><code>xyz[3]</code></td></tr><tr><td>vehicle_control_mode</td><td><code>flag_control_rates_enabled</code> (true if rates are stabilized), <code>flag_armed</code></td></tr><tr><td>vehicle_land_detected</td><td>...</td></tr><tr><td>vehicle_rates_setpoint</td><td><code>timestamp</code>, <code>roll</code>, <code>pitch</code>, <code>yaw</code>, <code>thrust_body[3]</code> (for multicopter, [0] and [1] are usually 0 and [2] is negative throttle demand, normalized in body NED frame [-1, 1])</td></tr><tr><td>vehicle_status</td><td><code>vehicle_type</code></td></tr><tr><td>hover_thrust_estimate</td><td><code>hover_thrust</code> [0.1, 0.9]</td></tr><tr><td>vehicle_angular_velocity</td><td><code>xyz[3]</code></td></tr></tbody></table></details><details><summary>uORB Publications</summary><table><thead><tr><th>Topic</th><th>Description</th></tr></thead><tbody><tr><td>rate_ctrl_status</td><td><code>timestamp</code>, <code>rollspeed_integ</code>, <code>pitchspeed_integ</code>, <code>yawspeed_integ</code></td></tr><tr><td>vehicle_angular_acceleration_setpoint</td><td><code>timestamp</code>, <code>timestamp_sample</code>, <code>xyz[3]</code></td></tr><tr><td>vehicle_thrust_setpoint</td><td><code>timestamp</code>, <code>timestamp_sample</code>, <code>xyz[3]</code> (unit N)</td></tr><tr><td>vehicle_torque_setpoint</td><td><code>timestamp</code>, <code>timestamp_sample</code>, <code>xyz[3]</code> (unit N.m)</td></tr></tbody></table></details></details><br><details><summary><b>control_allocator</b></summary><ol><li>Update effectiveness matrix (repeat for each rotor)<ul><li>thrust = ct * axis</li><li>moment = ct <em> position x axis - ct </em> km * axis</li><li>Put thrust and moment in effectiveness matrix</li></ul></li><li>Set 0 effectiveness if act_min &gt;= act_max in params</li><li>Run allocation (pseudo-inverse)<ul><li>mix = pseudo-inverse(effectiveness)</li><li><strong>actuator_sp</strong> = mix * thrust_sp</li><li>Clip <strong>actuator_sp</strong></li><li>control_allocated = effectiveness * actuator_sp</li></ul></li><li>Publish <strong>actuator_sp</strong></li><li>Publish normalized actuator_sp as <strong>actuator_controls_4</strong> and <strong>actuator_controls_5</strong> for the mixer system</li></ol><details><summary>Class Diagram</summary><p><img alt="control allocator class diagram" src="/tech-details/assets/images/control_allocation-aa7c1f77c37757ecb72609d37b9b62dd.png"></p><p><a target="_blank" href="/tech-details/assets/files/ca-e37804e2f6c8662c2e403675f4fb7bec.drawio/">Draw.io source</a></p></details><details><summary>Parameters</summary><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>CA_AIRFRAME</td><td>0 Multirotor, 1 Standard VTOL (WIP), 2 Tiltrotor VTOL (WIP)</td></tr><tr><td>CA_METHOD</td><td>0 Pseudo-inverse with output clipping, 1 Pseudo-inverse with sequential desaturation technique</td></tr><tr><td>CA_BAT_SCALE_EN</td><td>Battery power level scaler</td></tr><tr><td>CA_AIR_SCALE_EN</td><td>Airspeed scaler</td></tr><tr><td>CA_ACT*_MIN</td><td>...</td></tr><tr><td>CA_ACT*_MAX</td><td>...</td></tr></tbody></table><p>Reference: <a href="https://docs.px4.io/master/en/advanced_config/parameter_reference.html#control-allocation" target="_blank" rel="noopener noreferrer">https://docs.px4.io/master/en/advanced_config/parameter_reference.html#control-allocation</a></p></details><details><summary>uORB Subscriptions</summary><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>battery_status</td><td>...</td></tr><tr><td>airspeed</td><td>...</td></tr><tr><td>vehicle_status</td><td>...</td></tr><tr><td>vehicle_torque_setpoint</td><td><code>xyz[3]</code>: torque setpoint along X, Y, Z body axis (in N.m)</td></tr><tr><td>vehicle_thrust_setpoint</td><td><code>xyz[3]</code>: thrust setpoint along X, Y, Z body axis (in N)</td></tr></tbody></table></details><details><summary>uORB Publications</summary><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>vehicle_actuator_setpoint</td><td><code>actuator[16]</code></td></tr><tr><td>control_allocator_status</td><td><code>timestamp</code>, <code>allocated_torque[3]</code>, <code>allocated_thrust[3]</code>, <code>unallocated_torque[3]</code>, <code>allocated_torque[3]</code>, <code>torque_setpoint_achieved</code>, <code>thrust_setpoint_achieved</code>, <code>actuator_saturation[NUM_ACTUATORS]</code></td></tr><tr><td>actuator_controls_4</td><td><code>control[8]</code></td></tr><tr><td>actuator_controls_5</td><td><code>control[8]</code></td></tr></tbody></table></details></details><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="sitl-gazebo-simulation"></a>SITL (Gazebo Simulation)<a class="hash-link" href="#sitl-gazebo-simulation" title="Direct link to heading">#</a></h2><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Clone the repo</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">git</span><span class="token plain"> clone -b lirc-ca-new https://github.com/lirc572/PX4-Autopilot.git --recursive</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">cd</span><span class="token plain"> PX4-Autopilot</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Run one of the make commands below to compile and start simulation:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Hexrotor x:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> px4_sitl_ctrlalloc gazebo_typhoon_ctrlalloc</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Quadrotor Wide:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> px4_sitl_ctrlalloc gazebo_iris_ctrlalloc</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Octorotor Coaxial:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">make</span><span class="token plain"> px4_sitl_ctrlalloc gazebo_iris_cox_ctrlalloc</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Stop one motor in PX4 Shell:</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R0_CT </span><span class="token number" style="color:#36acaa">0</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Commands of the control_allocator module: <a href="https://docs.px4.io/master/en/modules/modules_controller.html#description" target="_blank" rel="noopener noreferrer">https://docs.px4.io/master/en/modules/modules_controller.html#description</a></p><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>The <em>iris_cox</em> simulation does not work as expected. See the last section of this page for details.</p></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="control-allocation-algorithm-implementation-in-python"></a>Control Allocation Algorithm Implementation in Python<a class="hash-link" href="#control-allocation-algorithm-implementation-in-python" title="Direct link to heading">#</a></h2><p><a href="https://deepnote.com/project/PX4-9lguiAoGSLeQGbSWiN-9-g/%2Fctrlalloc.ipynb" target="_blank" rel="noopener noreferrer">https://deepnote.com/project/PX4-9lguiAoGSLeQGbSWiN-9-g/%2Fctrlalloc.ipynb</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="tlab-octo-coax-model"></a>TLab Octo-Coax Model<a class="hash-link" href="#tlab-octo-coax-model" title="Direct link to heading">#</a></h2><p>Incomplete Gazebo Model: <a href="https://github.com/lirc572/PX4-SITL_gazebo/tree/2ce391f77da6949b202d4eacda6cf8013abaee9a/models/octo_cox_tlab" target="_blank" rel="noopener noreferrer">GitHub link</a></p><details><summary>init script</summary><p>(<code>ROMFS/px4fmu_common/init.d/airframes/12001_octo_cox</code>)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><pre tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token shebang important">#!/bin/sh</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @name Octo Coaxial</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @type Octorotor Coaxial</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @class Copter</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @output MAIN1 motor 1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @output MAIN2 motor 2</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @output MAIN3 motor 3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @output MAIN4 motor 4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @output MAIN5 motor 5</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @output MAIN6 motor 6</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @output MAIN7 motor 7</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @output MAIN8 motor 8</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @board intel_aerofc-v1 exclude</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># @board bitcraze_crazyflie exclude</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> /etc/init.d/rc.mc_defaults</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">sh</span><span class="token plain"> /etc/init.d/rc.ctrlalloc</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token variable" style="color:#36acaa">$AUTOCNF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">yes</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">then</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> MPC_XY_VEL_I_ACC </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> MPC_XY_VEL_P_ACC </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> RTL_DESCEND_ALT </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> RTL_LAND_DELAY </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> MNT_MODE_IN </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> MAV_PROTO_VER </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> MPC_USE_HTE </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Set according to actual vehicle model</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> VM_MASS </span><span class="token number" style="color:#36acaa">1.4995</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 2.05</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> VM_INERTIA_XX </span><span class="token number" style="color:#36acaa">0.018343</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 0.029125</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> VM_INERTIA_YY </span><span class="token number" style="color:#36acaa">0.019718</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 0.029125</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> VM_INERTIA_ZZ </span><span class="token number" style="color:#36acaa">0.032193</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 0.055225</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_AIRFRAME </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_METHOD </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT0_MIN </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT1_MIN </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT2_MIN </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT3_MIN </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT4_MIN </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT5_MIN </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT6_MIN </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT7_MIN </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT0_MAX </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT1_MAX </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT2_MAX </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT3_MAX </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT4_MAX </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT5_MAX </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT6_MAX </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_ACT7_MAX </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># KM: CCW: +ve, CW: -ve</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># PZ: 5.5cm / 22.0cm = 0.25</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># https://docs.px4.io/master/en/airframes/airframe_reference.html#octorotor-coaxial</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R0_PX </span><span class="token number" style="color:#36acaa">0.7071068</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R0_PY </span><span class="token number" style="color:#36acaa">0.7071068</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R0_PZ -0.25</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R0_CT </span><span class="token number" style="color:#36acaa">11.7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 12.523</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R0_KM </span><span class="token number" style="color:#36acaa">0.0137</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0135</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R1_PX </span><span class="token number" style="color:#36acaa">0.7071068</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R1_PY -0.7071068</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R1_PZ -0.25</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R1_CT </span><span class="token number" style="color:#36acaa">11.7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 12.523</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R1_KM -0.0137 </span><span class="token comment" style="color:#999988;font-style:italic"># -0.0135</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R2_PX -0.7071068</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R2_PY -0.7071068</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R2_PZ -0.25</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R2_CT </span><span class="token number" style="color:#36acaa">11.7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 12.523</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R2_KM </span><span class="token number" style="color:#36acaa">0.0137</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0135</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R3_PX -0.7071068</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R3_PY </span><span class="token number" style="color:#36acaa">0.7071068</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R3_PZ -0.25</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R3_CT </span><span class="token number" style="color:#36acaa">11.7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 12.523</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R3_KM -0.0137 </span><span class="token comment" style="color:#999988;font-style:italic"># -0.0135</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R4_PX </span><span class="token number" style="color:#36acaa">0.7071068</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R4_PY -0.7071068</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R4_PZ </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R4_CT </span><span class="token number" style="color:#36acaa">11.7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 12.523</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R4_KM </span><span class="token number" style="color:#36acaa">0.0137</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0135</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R5_PX </span><span class="token number" style="color:#36acaa">0.7071068</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R5_PY </span><span class="token number" style="color:#36acaa">0.7071068</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R5_PZ </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R5_CT </span><span class="token number" style="color:#36acaa">11.7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 12.523</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R5_KM -0.0137 </span><span class="token comment" style="color:#999988;font-style:italic"># -0.0135</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R6_PX -0.7071068</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R6_PY </span><span class="token number" style="color:#36acaa">0.7071068</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R6_PZ </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R6_CT </span><span class="token number" style="color:#36acaa">11.7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 12.523</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R6_KM </span><span class="token number" style="color:#36acaa">0.0137</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0135</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R7_PX -0.7071068</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R7_PY -0.7071068</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R7_PZ </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R7_CT </span><span class="token number" style="color:#36acaa">11.7</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 12.523</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    param </span><span class="token builtin class-name">set</span><span class="token plain"> CA_MC_R7_KM -0.0137 </span><span class="token comment" style="color:#999988;font-style:italic"># -0.0135</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">fi</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> MAV_TYPE </span><span class="token number" style="color:#36acaa">13</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># set MIXER octo_cox</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> MIXER direct</span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token builtin class-name">set</span><span class="token plain"> PWM_OUT </span><span class="token number" style="color:#36acaa">12345678</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></details><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="problems"></a>Problems<a class="hash-link" href="#problems" title="Direct link to heading">#</a></h2><p>Currently the iris_cox simulation does not work as expected. The same gazebo model works with the old control allocation implementation (<code>make px4_sitl gazebo_iris_cox</code>) but not under the new control allocation structure.</p><p>With the new implementation, as long as <code>CA_ACT*_MIN</code> is set to be &gt;= <code>CA_ACT*_MAX</code>, the corresponding PWM output will be set to 1500. By default all <code>CA_ACT*_MIN</code> and <code>CA_ACT*_MAX</code> are set to <code>0.0</code>, so any unconfigured motor will output <code>1500</code>.</p><p>Below are some simulation results:</p><ul><li>only configure R0-R3 â†’ works</li><li>only configure R4-R7 â†’ accelerate upwards as soon as arm</li><li>configure all R0-R7 â†’ accelerate upwards as soon as arm</li><li>configure R0 â†’ okay to arm</li><li>configure R4 â†’ upsidedown</li><li>configure R0-R3 + R4 â†’ okay to arm</li><li>configure R0-R3 + R5 â†’ okay to arm</li><li>configure R0-R3 + R4 + R5 â†’ when arm, front goes up â†’ upsidedown</li><li>configure R0-R3 + R6 â†’ okay to arm</li><li>configure R0-R3 + R7 â†’ okay to arm</li><li>configure R0-R3 + R6 + R7 â†’ when arm, front goes up â†’ upsidedown</li></ul><p>Below are my guesses of what went wrong:</p><ul><li>Even if the PWM output of a motor is 1500 (when left unconfigured), gazebo does not necessarily simulate the prop rotating at that speed, since the vehicle stays on the ground even if all lower 4 motors receive a PWM output of 1500.</li><li>There is something wrong with the gazebo motor definition, since one side of the vehicle will tilt upwards if we enable 2 lower motors at the same side even if their PWM output is only a little above 1000.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-to-construct-the-iris_cox-gazebo-model"></a>How to Construct the iris_cox Gazebo Model:<a class="hash-link" href="#how-to-construct-the-iris_cox-gazebo-model" title="Direct link to heading">#</a></h3><p><a href="https://github.com/lirc572/PX4-SITL_gazebo/blob/c79686bd8d796bf4e50a0ffe521999059ac174ab/models/iris_cox_ctrlalloc/iris_cox_ctrlalloc.sdf" target="_blank" rel="noopener noreferrer">https://github.com/lirc572/PX4-SITL_gazebo/blob/c79686bd8d796bf4e50a0ffe521999059ac174ab/models/iris_cox_ctrlalloc/iris_cox_ctrlalloc.sdf</a></p><ul><li>The iris_cox model is based on the original iris model in PX4-SITL_gazebo.</li><li>Duplicate the rotor_0 - rotor_3 links and joints, and update their name and position (as rotor_4 - rotor_7).</li><li>Add 4 new <em>libgazebo_motor_model</em> plugins to match the lower 4 motors.</li><li>Update the <em>mavlink_interface</em> plugin, edit the control_channels â†’ rotor5 - rotor8 based on rotor1 - rotor4.</li></ul></div><footer class="row docusaurus-mt-lg"><div class="col"></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-08-14T16:02:32.000Z">8/14/2021</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tech-details/docs/hardware/px4-firmware/px4-camera-trigger/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Hardware Camera Trigger</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tech-details/docs/hardware/px4-firmware/px4-FAQ/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">PX4 FAQ Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link">Introduction</a></li><li><a href="#overall-structure" class="table-of-contents__link">Overall Structure</a></li><li><a href="#sitl-gazebo-simulation" class="table-of-contents__link">SITL (Gazebo Simulation)</a></li><li><a href="#control-allocation-algorithm-implementation-in-python" class="table-of-contents__link">Control Allocation Algorithm Implementation in Python</a></li><li><a href="#tlab-octo-coax-model" class="table-of-contents__link">TLab Octo-Coax Model</a></li><li><a href="#problems" class="table-of-contents__link">Problems</a><ul><li><a href="#how-to-construct-the-iris_cox-gazebo-model" class="table-of-contents__link">How to Construct the iris_cox Gazebo Model:</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc1/">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc2/">Second Doc</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/blog/">Blog</a></li><li class="footer__item"><a href="https://github.com/tlab-uav/tech-details" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2022 TSL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/tech-details/assets/js/runtime~main.750cdc36.js"></script>
<script src="/tech-details/assets/js/main.010924a9.js"></script>
</body>
</html>