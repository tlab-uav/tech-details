<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.3">
<link rel="alternate" type="application/rss+xml" href="/tech-details/blog/rss.xml" title="117411 TSL UAV Tech Details Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/tech-details/blog/atom.xml" title="117411 TSL UAV Tech Details Blog Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous"><title data-react-helmet="true">Basalt Backend Walkthrough | 117411 TSL UAV Tech Details</title><meta data-react-helmet="true" property="og:url" content="https://tlab-uav.github.io//tech-details/docs/research/vio/basalt-backend"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Basalt Backend Walkthrough | 117411 TSL UAV Tech Details"><meta data-react-helmet="true" name="description" content="Overview &amp; Class Names"><meta data-react-helmet="true" property="og:description" content="Overview &amp; Class Names"><link data-react-helmet="true" rel="shortcut icon" href="/tech-details/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://tlab-uav.github.io//tech-details/docs/research/vio/basalt-backend"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/research/vio/basalt-backend" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://tlab-uav.github.io//tech-details/docs/research/vio/basalt-backend" hreflang="x-default"><link rel="stylesheet" href="/tech-details/assets/css/styles.032a5ccc.css">
<link rel="preload" href="/tech-details/assets/js/runtime~main.67525d22.js" as="script">
<link rel="preload" href="/tech-details/assets/js/main.71f8dbb0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image">Hardware</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image">Jetson TX2</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started">Jetson Xavier NX</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/cameras/tiscamera-install">Cameras</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/px4-firmware/px4-overview">PX4 Firmware</a></li><li><a class="dropdown__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview">UAV Platform</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/systems/vicon">Systems</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/systems/ros-coordinate-systems">ROS Coordinate Systems</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/unity-simulator">Simulations</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/vicon">Vicon</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/leviosa/leviosa">Leviosa Platform</a></li><li><a class="dropdown__link" href="/tech-details/docs/systems/ddrone_v2/ddrone">Past Platforms : ddrone v2</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions">Linux</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/linux/getting-started/overview">Getting Started</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/packages/file-systems">Software Packages</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/ros/using-catkin-build">ROS</a></li><li><a class="dropdown__link" href="/tech-details/docs/linux/kernel/grub-default-kernel">Drivers &amp; Kernel</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a class="navbar__item navbar__link" href="/tech-details/docs/productivity/git/git">Productivity</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/productivity/git/git">Git Version Control</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/cmake_debug/cmake">CMake and Debugging</a></li><li><a class="dropdown__link" href="/tech-details/docs/productivity/uiux/pangolin">UI/UX Tools</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--left"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/tech-details/docs/research/flight-data/flight-data-analysis">Research</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/tech-details/docs/research/flight-data/flight-data-analysis">Flight Data</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/calibration/getting-started">Sensor Calibration</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/collision-avoidance/overview-problems">Collision Avoidance</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/tech-details/docs/research/vio/basalt-overview">VIO</a></li><li><a class="dropdown__link" href="/tech-details/docs/research/edt/edt-overview">EDT</a></li></ul></div><a class="navbar__item navbar__link" href="/tech-details/docs/examples/doc0">Examples (To Edit)</a><a class="navbar__item navbar__link" href="/tech-details/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://bitbucket.org/nusuav/tl-tech-details/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>BitBucket<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input type="search" id="search_input_react" placeholder="Search" aria-label="Search" class="navbar__search-input search-bar"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/tech-details/"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/tech-details/img/android-chrome-192x192.png" alt="My Site Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">TSL Tech Details</b></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image">Hardware</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-tx2/flash-existing-image">Jetson TX2</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/jetson-xavier-nx/getting-started">Jetson Xavier NX</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/cameras/tiscamera-install">Cameras</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/px4-firmware/px4-overview">PX4 Firmware</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/hardware/UAV-Platform/Multirotor-overview">UAV Platform</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/systems/vicon">Systems</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/ros-coordinate-systems">ROS Coordinate Systems</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/unity-simulator">Simulations</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/vicon">Vicon</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/leviosa/leviosa">Leviosa Platform</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/systems/ddrone_v2/ddrone">Past Platforms : ddrone v2</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/linux/getting-started/gnome-shell-extensions">Linux</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/getting-started/overview">Getting Started</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/packages/file-systems">Software Packages</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/ros/using-catkin-build">ROS</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/linux/kernel/grub-default-kernel">Drivers &amp; Kernel</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" role="button" href="/tech-details/docs/productivity/git/git">Productivity</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/git/git">Git Version Control</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/cmake_debug/cmake">CMake and Debugging</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/productivity/uiux/pangolin">UI/UX Tools</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a aria-current="page" class="menu__link menu__link--sublist navbar__link--active" role="button" href="/tech-details/docs/research/flight-data/flight-data-analysis">Research</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/flight-data/flight-data-analysis">Flight Data</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/calibration/getting-started">Sensor Calibration</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/collision-avoidance/overview-problems">Collision Avoidance</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/tech-details/docs/research/vio/basalt-overview">VIO</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/research/edt/edt-overview">EDT</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/docs/examples/doc0">Examples (To Edit)</a></li><li class="menu__list-item"><a class="menu__link" href="/tech-details/blog">Blog</a></li><li class="menu__list-item"><a href="https://bitbucket.org/nusuav/tl-tech-details/" target="_blank" rel="noopener noreferrer" class="menu__link"><span>BitBucket<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu menu--responsive thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA" aria-label="Sidebar navigation"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Flight Data</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/flight-data/flight-data-analysis">Flight Data Analysis</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Camera Calibration</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/calibration/getting-started">Getting Started with Kalibr</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/calibration/calibration-target-params">Calibration Targets &amp; Params</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/calibration/kalibr-result-conventions">Kalibr Result Conventions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/calibration/calibration-procedures">Calibration Procedures</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/calibration/verify-by-kalibr-validator">Verify by Kalibr Validator</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/calibration/verify-by-triangulation-depth">Verify by Triangulation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/calibration/Calibration results/Calibration results">Calibration results</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Collision Avoidance</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/collision-avoidance/overview-problems">Overview &amp; Current Problems</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/collision-avoidance/design-choices">Design Choices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/collision-avoidance/controls">CA Controls</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">VIO</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/research/vio/basalt-overview">Framework Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/research/vio/basalt-tuning">System Tuning &amp; Configs</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/tech-details/docs/research/vio/basalt-backend">Basalt Backend (VioEstimator)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/research/vio/basalt-frontend">Basalt Frontend (Optical Flow)</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/tech-details/docs/research/vio/basalt-tests">System Level Tests</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">EDT</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/edt/edt-overview">Framework Overview</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/edt/MapUpdater">Map Updater</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/edt/stereo">stereo</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">MSCKF_VIO Loop Closure</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/tech-details/docs/research/msckf_vio/loop_closure">loop_closure Overview</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="markdown"><header><h1 class="h1Heading_27L5">Basalt Backend Walkthrough</h1></header><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="overview--class-names"></a>Overview &amp; Class Names<a class="hash-link" href="#overview--class-names" title="Direct link to heading">#</a></h2><p>The backend of the VIO framework is contained with the base class <code>VioEstimatorBase</code> (defined in <code>vio_estimator.h</code>) which is the parent class of two type of the estimator possible:</p><ul><li><code>KeypointVioEstimator</code>(defined in <code>keypoint_vio.h</code>), and</li><li><code>KeypointVoEstimator</code>(defined in <code>keypoint_vo.h</code>)</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// how the factory class initialise to different type of estimator depends on use_imu variable</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">VioEstimatorBase</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">Ptr </span><span class="token class-name">VioEstimatorFactory</span><span class="token operator" style="color:#393A34">::</span><span class="token function" style="color:#d73a49">getVioEstimator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> VioConfig</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Calibration</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">double</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> cam</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> Eigen</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">Vector3d</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">bool</span><span class="token plain"> use_imu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  VioEstimatorBase</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">Ptr res</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">use_imu</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">KeypointVioEstimator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cam</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    res</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reset</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">KeypointVoEstimator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cam</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> res</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>For the purpose of this walkthrough honly <code>KeypointVioEstimator</code> is conerned. We are interested in understanding how optical flow observations (keypoints) are used to form keyframes, and 3D landmarks.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="io-of-base-class-of-vioestimator"></a>I/O of Base Class of VioEstimator<a class="hash-link" href="#io-of-base-class-of-vioestimator" title="Direct link to heading">#</a></h2><p>The <strong>inputs</strong> are optical results (observations of keypoints) and imu inputs:</p><ol><li>A TBB queue, <code>vision_data_queue</code> of type <code>OpticalFlowResult::Ptr</code>, where each optical flow result contains <ol><li>the 64-bit timestamp,</li><li>a vector named <code>observations</code>, containing a map between the keypoint ID <code>KeypointId</code>  and its 2D transformations <code>Eigen::AffineCompact2f</code> (2D transformation literally represent the keypoint 2D location in the observing camera frame, aka. the uv coordinates)</li><li>and a pointer to the original image data (<code>std::vector&lt;ImageData&gt;</code>), for the current frame</li></ol></li><li>A TBB queue, <code>imu_data_queue</code> of type <code>ImuData::Ptr</code>, storing the timestamp, and the accelerometer and gyroscope information</li></ol><p>The <strong>outputs</strong> are output states, ‚ö†Ô∏è marginalised data?, and vio visualisation data:</p><ol><li>A pointer to TBB queue <code>out_state_queue</code> of type <code>PoseVelBiasState::Ptr</code> containing all the states which are: <code>t_ns</code> timestamp of the state in nanoseconds; <code>T_w_i</code> pose of the state; <code>vel_w_i</code> linear velocity of the state; <code>bias_gyro</code> gyroscope bias; <code>bias_accel  </code>accelerometer bias.</li><li>A pointer to TBB queue <code>out_marg_queue</code> of type <code>MargData::Ptr</code></li><li>A pointer to TBB queue<code>out_vis_queue</code> of type <code>VioVisualizationData::Ptr</code></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="initialisation"></a>Initialisation<a class="hash-link" href="#initialisation" title="Direct link to heading">#</a></h2><p>With the incoming flow of visual optical flow observations and IMU data, the backend has a way to initialise itself with a proper initial pose (and velocity) and bias estimate. We can choose to initialise either just the biases and attitude (quaternion), or with the transformation and velocity as well.</p><p><strong>Key things to note:</strong></p><ul><li>The current implementation in Basalt only does bias and quaternion initialisation (all others set): bias is <u>set them to zero</u>, and attitude is done by two-vector calculation from single data point of imu -&gt; <strong>TODO [Improvement]</strong></li><li>The initial IMU-world transformation <code>T_w_i_init</code> has a very special way to initialise, which is yaw ignorant:<ul><li>First the accelerometer raw reading is used (one data point), it is assumed to be the gravity vector</li><li>The gravity vector is rotated to be aligned with the positive Z axis, this rotation action is recorded as a quaternion. This quaternion is essentially performing basis changing from body frame to global frame.</li><li>That is to say, the transformation is only defined by the plane that the gravity vector and the +ve z-axis make as well as the angle itself. This does not take account into the correct yaw, a.k.a the initial heading is not consistent, which is a function of how the IMU is mounted and its initial orientation.</li><li><strong>NOTE</strong>: Therefore, with a fixed mounting between the IMU and camera, and with a fixed up direction of the whole rig (e.g. the drone), we can pre-calculate the rotation matrix to make the initialised $T$ transformation matrix to face our desired coordinate convention (e.g. NWU).</li></ul></li><li>The pre-integration buffer <code>imu_meas</code> is also initialised here, taken account of the bias (which is always set to zeros in the implementation)</li><li>The bundle adjustment states <code>frame_states</code> of type <code> Eigen::aligned_map&lt;int64_t, PoseVelBiasStateWithLin&gt;</code></li><li><code>marg_order</code>??</li><li>The processing thread is created within the <code>initialize()</code> function, which is basically a <strong>while</strong> loop, by the means of lamda function and <code>std::thread</code>.</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="the-processing-thread-within-keypointvioestimator"></a>The Processing Thread (within <code>KeypointVioEstimator</code>)<a class="hash-link" href="#the-processing-thread-within-keypointvioestimator" title="Direct link to heading">#</a></h2><p><strong>Configs</strong>:</p><ul><li><p><code>vio_enforce_realtime</code> is used to set when the backend cannot catch up with optical flow results. It will throw away all previous results, except the latest one in the queue.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vio_enforce_realtime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">// drop current frame if another frame is already in the queue.</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vision_data_queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">try_pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">curr_frame</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">skipped_image</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">skipped_image</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">          std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">cerr</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;[Warning] skipped opt flow size: &quot;</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain">skipped_image</span><span class="token operator" style="color:#393A34">&lt;&lt;</span><span class="token plain">std</span><span class="token operator" style="color:#393A34">::</span><span class="token plain">endl</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">curr_frame</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ul><ul><li><p><code>vio_min_triangulation_dist</code> is used to determine whether the two camera frames are suitable for triangulation in generating the landmarks, during a keyframe initialisation</p></li><li><p><code>vio_new_kf_keypoints_thresh</code> is the threshold for the ratio between tracked landmarks and total tracked keypoints (e.g. raito of 0.7)</p></li><li><p><code>vio_min_frames_after_kf</code> </p></li></ul><p><strong>Calibs</strong>:</p><ul><li><p><code>cam_time_offset_ns</code> offset of the camera in time, should be normally 0</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Correct camera time offset</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">      curr_frame</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">t_ns </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> calib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cam_time_offset_ns</span><span class="token punctuation" style="color:#393A34">;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ul><p>After initialisation, the actual processing will only start with two concecutive frames (when both <code>prev_frame</code> and <code>curr_frame</code> are defined):</p><ul><li>Pre-integration is performed, between the two frames, using the latest bias estimation. Blocking may happen, as it reads IMU buffer all the way until one pass the current frame&#x27;s timestamp (<code>while (data-&gt;t_ns &lt;= curr_frame-&gt;t_ns)</code>)<ul><li>Note: the integration will ensure the upper integral timestamp is at least the current frame timestamp (it will make fake IMU measurement by shifting the last IMU readings, when needed)</li></ul></li><li>At the same time, bias correction <code>getCalibrated()</code> are also done for both gyro and accelerometer</li><li>The bulk of the calculation is doen within the <code>measure(curr_frame, meas)</code> function, which is discussed next</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="the-measure-routine"></a>The <code>Measure()</code> Routine<a class="hash-link" href="#the-measure-routine" title="Direct link to heading">#</a></h2><p>The <code>measure()</code> routine takes in the current frame optical flow observations, as well as the IMU pre-integration results.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="imu-measurements-processing"></a>IMU measurements Processing<a class="hash-link" href="#imu-measurements-processing" title="Direct link to heading">#</a></h3><ul><li><code>frame_states</code> is updated with a entry key <code>last_state_t_ns</code> (current frame timestamp), to be stored with the IMU predicted state</li><li><code>imu_meas</code> is also updated by indexed by the previous frame&#x27;s timestamp</li><li>This whole step might be skipped if IMU measurement is not passed in</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="optical-flow-results-processing"></a>Optical Flow Results Processing<a class="hash-link" href="#optical-flow-results-processing" title="Direct link to heading">#</a></h3><p>Pre-processing:</p><ul><li><p><code>prev_opt_flow_res</code> stores, with key in timestamp, the optical flow measurement struct pointer, up to the current time frame</p></li><li><p>For each camera frame, iterate through all observations. If that observed keypoint is already a landmark, add the observation to the landmark database; if not put it to the unconnected observation <strong>set</strong>.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly cpp"><pre tabindex="0" class="prism-code language-cpp codeBlock_23N8 thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// skeleton</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">size_t i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> opt_flow_meas</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">observations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">auto</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> kv_obs </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> opt_flow_meas</span><span class="token operator" style="color:#393A34">-&gt;</span><span class="token plain">observations</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lmdb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">landmarkExists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kpt_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            num_points_connected</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">tcid_host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frame_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">++</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">            unconnected_obs0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">emplace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kpt_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div></li></ul><p>Key-framing:</p></div><footer class="row docusaurus-mt-lg"><div class="col"></div><div class="col lastUpdated_3DPF">Last updated on <b><time datetime="2021-07-14T06:14:52.000Z">7/14/2021</time></b></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/tech-details/docs/research/vio/basalt-tuning"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ System Tuning &amp; Configs</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/tech-details/docs/research/vio/basalt-frontend"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Basalt Frontend (Optical Flow) ¬ª</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview--class-names" class="table-of-contents__link">Overview &amp; Class Names</a></li><li><a href="#io-of-base-class-of-vioestimator" class="table-of-contents__link">I/O of Base Class of VioEstimator</a></li><li><a href="#initialisation" class="table-of-contents__link">Initialisation</a></li><li><a href="#the-processing-thread-within-keypointvioestimator" class="table-of-contents__link">The Processing Thread (within <code>KeypointVioEstimator</code>)</a></li><li><a href="#the-measure-routine" class="table-of-contents__link">The <code>Measure()</code> Routine</a><ul><li><a href="#imu-measurements-processing" class="table-of-contents__link">IMU measurements Processing</a></li><li><a href="#optical-flow-results-processing" class="table-of-contents__link">Optical Flow Results Processing</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc1">Style Guide</a></li><li class="footer__item"><a class="footer__link-item" href="/tech-details/docs/doc2">Second Doc</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/tech-details/blog">Blog</a></li><li class="footer__item"><a href="https://bitbucket.org/nusuav/tl-tech-details/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>BitBucket<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright ¬© 2021 TSL. Built with Docusaurus.</div></div></div></footer></div>
<script src="/tech-details/assets/js/runtime~main.67525d22.js"></script>
<script src="/tech-details/assets/js/main.71f8dbb0.js"></script>
</body>
</html>